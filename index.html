<!DOCTYPE html>
<html lang="pt-br">
<!--
    CONFIGURAÇÃO DE TOKEN DE NOTIFICAÇÃO:
    O token será injetado automaticamente da variável de ambiente TOKEN_NOTIFICATION
    durante o processo de build/deploy.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usuário</title>
    <!-- Incluindo o Tailwind CSS para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Usando a fonte Inter para um visual mais moderno */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo customizado para o botão de perfil ativo na barra de navegação */
        .active-nav-item {
            background-color: #E6F7F0; /* Um verde bem claro */
            color: #00BFA5; /* Cor verde principal */
        }
        /* Esconde a scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Responsividade adicional */
        @media (min-width: 1024px) {
            body {
                background: linear-gradient(135deg, #f0f9ff 0%, #f8fafc 100%);
                padding: 1rem 0;
            }
        }
        
        @media (max-width: 640px) {
            /* Otimizações para mobile */
            .touch-optimization {
                min-height: 44px; /* iOS touch target minimum */
            }
        }
        
        /* Transições suaves para hover */
        .transition-colors {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        /* Estilos para transições suaves */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .medal-unlocked {
            border-color: #34D399; /* Verde para medalha desbloqueada */
            background-color: #F0FAF7;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Injeção de variáveis de ambiente -->
    <script>
        // Esta variável será substituída durante o build/deploy pela variável de ambiente real
        window.TOKEN_NOTIFICATION = "${TOKEN_NOTIFICATION}" || "abc123";
        
        // Remove placeholder se não foi substituído
        if (window.TOKEN_NOTIFICATION === "${TOKEN_NOTIFICATION}") {
            window.TOKEN_NOTIFICATION = "abc123";
            console.warn("⚠️ TOKEN_NOTIFICATION não foi configurado, usando valor padrão");
        }
    </script>

    <!-- Container principal responsivo -->
    <div class="w-full mx-auto bg-white min-h-screen sm:max-w-sm md:max-w-md lg:max-w-md xl:max-w-lg lg:shadow-xl lg:rounded-2xl lg:mt-4 lg:mb-4 lg:min-h-[calc(100vh-2rem)] flex flex-col relative overflow-hidden">

        <!-- TELA DE LOGIN/TELEFONE -->
        <div id="phone-screen" class="flex flex-col flex-grow">
            <!-- Cabeçalho -->
            <header class="bg-gradient-to-r from-purple-400 to-pink-400 p-4 sm:p-6 text-center">
                <div class="flex flex-col items-center">
                    <div class="flex items-center space-x-2 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <h1 class="text-2xl font-bold text-white">Pagaleve</h1>
                    </div>
                    <p class="text-white/80">Bem-vindo ao clube de benefícios</p>
                </div>
            </header>

            <!-- Conteúdo Principal -->
            <div class="flex-grow flex flex-col justify-center px-6 py-8">
                <div class="space-y-6">
                    <div class="text-center space-y-2">
                        <h2 class="text-2xl font-bold text-gray-900">Entre com seu telefone</h2>
                        <p class="text-gray-600">Digite seu número para receber o código de confirmação</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label for="phone-input" class="block text-sm font-medium text-gray-700 mb-2">
                                Número do telefone
                            </label>
                            <div class="relative">
                                <input 
                                    type="tel" 
                                    id="phone-input" 
                                    placeholder="+55 (11) 99999-9999"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent text-lg"
                                    maxlength="19"
                                />
                            </div>
                        </div>

                        <button 
                            id="send-otp-btn" 
                            class="w-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-bold py-3 px-6 rounded-xl transition-all hover:from-purple-500 hover:to-pink-500 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Enviar código
                        </button>
                    </div>

                    <div id="phone-error" class="hidden text-red-500 text-sm text-center"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 text-center text-sm text-gray-500">
                <p>Ao continuar, você concorda com nossos Termos de Uso</p>
            </div>
        </div>

        <!-- TELA DE CONFIRMAÇÃO OTP -->
        <div id="otp-screen" class="hidden flex flex-col flex-grow">
            <!-- Cabeçalho -->
            <header class="bg-gradient-to-r from-purple-400 to-pink-400 p-4 sm:p-6">
                <div class="flex justify-between items-center">
                    <button id="back-to-phone-btn" class="text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="flex flex-col items-center">
                        <h1 class="text-xl font-semibold text-white">Confirme seu código</h1>
                    </div>
                    <div class="w-6"></div>
                </div>
            </header>

            <!-- Conteúdo Principal -->
            <div class="flex-grow flex flex-col justify-center px-6 py-8">
                <div class="space-y-6">
                    <div class="text-center space-y-2">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Digite o código</h2>
                        <p class="text-gray-600">
                            Enviamos um código para <span id="phone-display" class="font-medium text-gray-900"></span>
                        </p>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-center space-x-2">
                            <input type="text" class="otp-input w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent" maxlength="1" />
                            <input type="text" class="otp-input w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent" maxlength="1" />
                            <input type="text" class="otp-input w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent" maxlength="1" />
                            <input type="text" class="otp-input w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent" maxlength="1" />
                            <input type="text" class="otp-input w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent" maxlength="1" />
                            <input type="text" class="otp-input w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent" maxlength="1" />
                        </div>

                        <button 
                            id="verify-otp-btn" 
                            class="w-full bg-gradient-to-r from-purple-400 to-pink-400 text-white font-bold py-3 px-6 rounded-xl transition-all hover:from-purple-500 hover:to-pink-500 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Confirmar
                        </button>
                    </div>

                    <div class="text-center space-y-2">
                        <p class="text-sm text-gray-600">Não recebeu o código?</p>
                        <button id="resend-otp-btn" class="text-purple-500 font-medium text-sm hover:text-purple-600">
                            Reenviar código
                        </button>
                    </div>

                    <div id="otp-error" class="hidden text-red-500 text-sm text-center"></div>
                </div>
            </div>
        </div>

        <!-- TELA DE PERFIL -->
        <div id="profile-screen" class="hidden flex flex-col flex-grow">
            <!-- Cabeçalho Superior -->
            <header class="bg-gradient-to-r from-purple-400 to-pink-400 p-4 sm:p-6">
                <div class="flex justify-between items-center">
                    <button class="text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="flex flex-col items-center">
                        <div class="flex items-center space-x-2 mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            <h1 class="text-xl font-semibold text-white">Clube Leve+</h1>
                        </div>
                        <div id="subscription-status" class="flex items-center space-x-1 text-white text-sm">
                            <span>Inativo</span>
                        </div>
                        <div class="user-greeting text-white/80 text-xs mt-1">
                            Bem-vindo!
                        </div>
                    </div>
                    <button id="logout-btn" class="text-white text-sm font-medium hover:text-white/80 transition-colors">
                        Sair
                    </button>
                </div>
            </header>

            <!-- Seção Economia Total -->
            <section class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 bg-white">
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <h2 class="text-sm text-gray-600 mb-1">Economia total</h2>
                            <p id="economia-total-valor" class="text-2xl font-bold text-gray-900">R$ 0,00</p>
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"/>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-sm text-gray-600 mb-1">Cashback disponível</h2>
                            <p id="cashback-disponivel" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-4 0h-4v-1h4m0 10v1h4v-1m-4 0h-4v1h4" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div id="subscription-buttons-container">
                        <button id="subscription-action-btn" class="w-full bg-purple-500 text-white font-medium py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors">
                            Assine seu plano
                        </button>
                    </div>
                </div>
            </section>

            <!-- Seção Cupons da Assinatura -->
            <section class="px-4 sm:px-6 lg:px-8 pb-4 sm:pb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 id="cupons-section-title" class="text-lg font-semibold text-gray-900">Cupons</h3>
                        <p id="cupons-section-subtitle" class="text-sm text-gray-600" style="display: none;">4 para todas as compras</p>
                    </div>
                    <button id="cupons-ver-detalhes-btn" class="text-red-500 text-sm font-medium">
                        Ver detalhes
                    </button>
                </div>
                
                <div id="cupons-visual-container" class="flex space-x-3 overflow-x-auto pb-2">
                    <!-- Cupons serão gerados dinamicamente pelo JavaScript -->
                </div>
                
                <p id="cupons-restam-text" class="text-sm text-gray-600 mt-3" style="display: none;">
                    Restam <span class="font-semibold text-purple-600">4 de 4 cupons</span>
                </p>
            </section>



            <!-- Seção Conquistas -->
            <section class="px-4 sm:px-6 lg:px-8 pb-4 sm:pb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Conquistas</h3>
                        <p class="text-sm text-gray-600">Suas medalhas e conquistas</p>
                    </div>
                    <button id="conquistas-ver-detalhes-btn" class="text-red-500 text-sm font-medium">
                        Ver todas
                    </button>
                </div>
                
                <div class="flex space-x-3 overflow-x-auto pb-2">
                    <div class="flex-shrink-0 w-16 h-16 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center border-4 border-yellow-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"/>
                        </svg>
                    </div>
                    <div class="flex-shrink-0 w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center border-4 border-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="flex-shrink-0 w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center border-4 border-green-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div class="flex-shrink-0 w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center border-4 border-gray-400 opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                </div>
                
                <p id="medals-summary" class="text-sm text-gray-600 mt-3">
                    <span id="medals-unlocked-count" class="font-semibold text-green-600">0 conquistadas</span> de <span id="medals-total-count">6</span> medalhas disponíveis
                </p>
            </section>

            <!-- Seção de Saudação -->
            <section class="px-4 sm:px-6 lg:px-8 pb-4 sm:pb-6" style="display: none;">
                <div class="text-center">
                    <h2 class="text-lg sm:text-xl lg:text-2xl font-medium text-gray-700 mb-3">Olá, João</h2>
                    <div id="cashback-balance" class="inline-flex items-center space-x-2 bg-gray-50 px-3 sm:px-4 py-2 rounded-full text-sm sm:text-base">
                        <!-- Será preenchido pelo JavaScript -->
                    </div>
                </div>
            </section>


            <!-- Conteúdo Principal (Lista de Opções) -->
            <main class="flex-grow px-4 sm:px-6 lg:px-8 py-4 space-y-6 sm:space-y-8 overflow-y-auto no-scrollbar">
                <div class="space-y-3 sm:space-y-4">
                    <ul class="text-gray-700 space-y-1 sm:space-y-2">
                        <li class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg opacity-50 cursor-not-allowed" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg><span class="font-medium text-gray-400 text-sm sm:text-base">Minhas compras</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li id="simular-compra-btn" class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span class="font-medium text-sm sm:text-base">Simular Compra</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li id="clube-beneficios-btn" class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg><span class="font-medium text-sm sm:text-base">Clube de Benefícios</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li id="cupons-btn" class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" /></svg><span class="font-medium text-sm sm:text-base">Cupons</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li id="show-achievements-btn" class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg><span class="font-medium text-sm sm:text-base">Conquistas</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg opacity-50 cursor-not-allowed" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4z" /></svg><span class="font-medium text-gray-400 text-sm sm:text-base">Dados pessoais</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg opacity-50 cursor-not-allowed" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg><span class="font-medium text-gray-400 text-sm sm:text-base">Meus interesses</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg opacity-50 cursor-not-allowed" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="font-medium text-gray-400 text-sm sm:text-base">Preferências</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                        <li class="flex items-center justify-between p-3 sm:p-4 lg:p-5 rounded-lg opacity-50 cursor-not-allowed" style="display: none;"><div class="flex items-center space-x-3 sm:space-x-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg><span class="font-medium text-gray-400 text-sm sm:text-base">Indique amigos</span></div><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                    </ul>
                </div>
            </main>
        </div>

        <!-- TELA DE CLUBE DE BENEFÍCIOS (escondida por padrão) -->
        <div id="benefits-screen" class="hidden flex-col flex-grow">
            <header class="p-4 flex justify-between items-center border-b border-gray-200">
                <button id="back-to-profile-from-benefits-btn" class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <div class="flex items-center space-x-2">
                    <img src="assets/logo.png" alt="Pagaleve" class="h-6 w-6">
                    <h1 class="text-xl font-semibold text-gray-800">clube Pagaleve</h1>
                </div>
                <div class="w-6 h-6"></div>
            </header>

            <main class="flex-grow p-4 bg-gray-50 overflow-y-auto no-scrollbar">
                <!-- Banner principal -->
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-6 mb-6 text-white">
                    <div class="flex items-center justify-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-center mb-2">Clube de Benefícios</h2>
                    <p class="text-center text-purple-100">Desbloqueie vantagens exclusivas para você!</p>
                </div>

                <!-- Benefícios -->
                <div class="space-y-4 mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Seus benefícios incluem:</h3>
                    
                    <!-- Benefício 1: Cashback -->
                    <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center space-x-4">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-4 0h-4v-1h4m0 10v1h4v-1m-4 0h-4v1h4" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">1% de Cashback</h4>
                            <p class="text-sm text-gray-600">Ganhe 1% de volta em todas as suas compras</p>
                        </div>
                    </div>

                    <!-- Benefício 2: Taxa reduzida -->
                    <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">20% de Desconto na Taxa</h4>
                            <p class="text-sm text-gray-600">Diminuição de 20% na taxa de serviço</p>
                        </div>
                    </div>

                    <!-- Benefício 3: Cupons -->
                    <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center space-x-4">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">4 Cupons de R$ 15</h4>
                            <p class="text-sm text-gray-600">Para compras acima de R$ 200</p>
                        </div>
                    </div>
                </div>

                <!-- Botão de assinatura -->
                <div class="text-center">
                    <button id="subscribe-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 px-6 rounded-xl transition-all text-lg shadow-lg">
                        Assinar Agora
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Comece a aproveitar todos os benefícios hoje!</p>
                </div>
            </main>
        </div>

        <!-- TELA DE ASSINATURA ATIVA (escondida por padrão) -->
        <div id="active-subscription-screen" class="hidden flex-col flex-grow">
            <header class="p-4 flex justify-between items-center border-b border-gray-200">
                <button id="back-to-profile-from-active-btn" class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-semibold text-gray-800">Minha Assinatura</h1>
                <div class="w-6 h-6"></div>
            </header>

            <main class="flex-grow p-4 bg-gray-50 overflow-y-auto no-scrollbar">
                <!-- Status da assinatura -->
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl p-6 mb-6 text-white">
                    <div class="flex items-center justify-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-center mb-2">Assinatura Ativa</h2>
                    <p class="text-center text-green-100">Você está aproveitando todos os benefícios!</p>
                </div>

                <!-- Informações do plano -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Detalhes do Plano</h3>
                    <div id="subscription-details" class="space-y-3">
                        <!-- Será preenchido pelo JavaScript -->
                    </div>
                </div>

                <!-- Benefícios ativos -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Seus Benefícios Ativos</h3>
                    <div class="space-y-4">
                        <!-- Benefício 1: Cashback -->
                        <div class="flex items-center space-x-4 p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">1% de Cashback</h4>
                                <p class="text-sm text-gray-600">Ativo em todas as suas compras</p>
                            </div>
                            <span class="text-green-600 font-semibold text-sm">ATIVO</span>
                        </div>

                        <!-- Benefício 2: Taxa reduzida -->
                        <div class="flex items-center space-x-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">20% de Desconto na Taxa</h4>
                                <p class="text-sm text-gray-600">Aplicado automaticamente</p>
                            </div>
                            <span class="text-blue-600 font-semibold text-sm">ATIVO</span>
                        </div>

                        <!-- Benefício 3: Cupons -->
                        <div class="flex items-center space-x-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">4 Cupons de R$ 15</h4>
                                <p class="text-sm text-gray-600">Para compras acima de R$ 200</p>
                            </div>
                            <span class="text-yellow-600 font-semibold text-sm">DISPONÍVEL</span>
                        </div>
                    </div>
                </div>

                <!-- Botão de ação -->
                <div>
                    <button id="cancel-subscription-btn" class="w-full bg-white border-2 border-red-200 hover:border-red-300 text-red-600 hover:text-red-700 font-bold py-3 px-6 rounded-xl transition-all">
                        Cancelar Assinatura
                    </button>
                </div>
            </main>
        </div>

        <!-- TELA DE SELEÇÃO DE PLANOS (escondida por padrão) -->
        <div id="plans-screen" class="hidden flex-col flex-grow">
            <header class="p-4 flex justify-between items-center border-b border-gray-200">
                <button id="back-to-benefits-btn" class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-semibold text-gray-800">Escolha seu Plano</h1>
                <div class="w-6 h-6"></div>
            </header>

            <main class="flex-grow p-4 bg-gray-50 overflow-y-auto no-scrollbar">
                <div class="mb-6 text-center">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Selecione o plano ideal para você</h2>
                    <p class="text-sm text-gray-600">Quanto mais tempo, maior a economia!</p>
                </div>

                <div class="space-y-4 mb-8">
                    <!-- Plano 1 mês -->
                    <div class="plan-option bg-white p-4 rounded-xl border-2 border-gray-200 cursor-pointer transition-all hover:border-purple-300" data-plan="1" data-price="20" data-total="20">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Plano Mensal</h3>
                                <p class="text-sm text-gray-600">1 mês de benefícios</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-purple-600">R$ 19,99</div>
                                <div class="text-sm text-gray-500">por mês</div>
                            </div>
                        </div>
                    </div>

                    <!-- Plano 3 meses -->
                    <div class="plan-option bg-white p-4 rounded-xl border-2 border-gray-200 cursor-pointer transition-all hover:border-purple-300 relative" data-plan="3" data-price="55" data-total="60">
                        <div class="absolute -top-2 -right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                            ECONOMIZE 8,3%
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Plano Trimestral</h3>
                                <p class="text-sm text-gray-600">3 meses de benefícios</p>
                                <p class="text-xs text-green-600 font-medium">Economia de 8,3%</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-400 line-through">R$ 59,99</div>
                                <div class="text-2xl font-bold text-purple-600">R$ 54,99</div>
                                <div class="text-sm text-gray-500">R$ 18,33/mês</div>
                            </div>
                        </div>
                    </div>

                    <!-- Plano 6 meses -->
                    <div class="plan-option bg-white p-4 rounded-xl border-2 border-gray-200 cursor-pointer transition-all hover:border-purple-300 relative" data-plan="6" data-price="100" data-total="119,99">
                        <div class="absolute -top-2 -right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                            ECONOMIZE 16,7%
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Plano Semestral</h3>
                                <p class="text-sm text-gray-600">6 meses de benefícios</p>
                                <p class="text-xs text-green-600 font-medium">Economia de 16,7%</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-400 line-through">R$ 119,99</div>
                                <div class="text-2xl font-bold text-purple-600">R$ 99,99</div>
                                <div class="text-sm text-gray-500">R$ 16,67/mês</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="continue-to-payment-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 px-6 rounded-xl transition-all text-lg shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Continuar para Pagamento
                </button>
            </main>
        </div>

        <!-- TELA DE PAGAMENTO (escondida por padrão) -->
        <div id="payment-screen" class="hidden flex-col flex-grow">
            <header class="p-4 flex justify-between items-center border-b border-gray-200">
                <button id="back-to-plans-btn" class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-semibold text-gray-800">Pagamento</h1>
                <div class="w-6 h-6"></div>
            </header>

            <main class="flex-grow p-4 bg-gray-50 overflow-y-auto no-scrollbar">
                <!-- Resumo do plano selecionado -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Resumo do Pedido</h3>
                    <div id="selected-plan-summary" class="space-y-2">
                        <!-- Será preenchido pelo JavaScript -->
                    </div>
                </div>

                <!-- QR Code para pagamento -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 text-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Escaneie o QR Code para pagar</h3>
                    <div class="flex justify-center mb-4">
                        <img src="assets/qrcode.png" alt="QR Code PIX" class="w-48 h-48 rounded-lg border border-gray-200">
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Use o app do seu banco ou carteira digital</p>
                    <div class="text-center">
                        <div id="payment-total" class="text-2xl font-bold text-purple-600 mb-2">R$ 0,00</div>
                        <p class="text-sm text-gray-500">Valor total</p>
                    </div>
                </div>

                <button id="simulate-payment-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl transition-all text-lg shadow-lg">
                    Pagar Agora (Simulação)
                </button>
            </main>
        </div>

        <!-- TELA DE SIMULAÇÃO DE COMPRA (escondida por padrão) -->
        <div id="purchase-simulation-screen" class="hidden flex-col flex-grow">
            <header class="p-4 flex justify-between items-center border-b border-gray-200">
                <button id="back-to-profile-from-purchase-btn" class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-semibold text-gray-800">Simular Compra</h1>
                <div class="w-6 h-6"></div>
            </header>

            <main class="flex-grow p-4 bg-gray-50 overflow-y-auto no-scrollbar">
                <!-- Produto -->
                <div class="bg-white rounded-xl border border-gray-200 mb-4">
                    <div class="p-4">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">Smartphone XYZ</h3>
                                <p class="text-lg text-gray-800 mb-2">R$ 1.000,00</p>
                                <div id="cashback-info" class="flex items-center space-x-2 text-sm">
                                    <!-- Será preenchido pelo JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Parcelamento -->
                <div class="bg-white rounded-xl border border-gray-200 mb-6">
                    <div class="p-4">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.42 0 2.13.54 2.39 1.4.12.4.45.7.87.7h.3c.66 0 1.13-.65.9-1.27-.42-1.18-1.4-2.16-2.96-2.54V4.5c0-.83-.67-1.5-1.5-1.5S10 3.67 10 4.5v.66c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-1.65 0-2.5-.59-2.83-1.43-.15-.39-.49-.67-.9-.67h-.28c-.67 0-1.14.68-.89 1.3.57 1.39 1.9 2.21 3.4 2.53v.67c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-.65c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">4 parcelas quinzenais</h3>
                                <p class="text-gray-600">Confira o valor das parcelas</p>
                            </div>
                        </div>

                        <!-- Detalhes do parcelamento -->
                        <div class="space-y-4">
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <div>
                                        <span class="font-semibold text-gray-800">HOJE</span>
                                        <div class="text-sm text-gray-600">Taxa: R$ 20,00</div>
                                    </div>
                                    <span class="font-semibold text-gray-800">R$ 270,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                    <span class="text-gray-800">21/08/2025</span>
                                    <span class="text-gray-800">R$ 250,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                    <span class="text-gray-800">05/09/2025</span>
                                    <span class="text-gray-800">R$ 250,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                    <span class="text-gray-800">22/09/2025</span>
                                    <span class="text-gray-800">R$ 250,00</span>
                                </div>
                            </div>

                            <!-- Economia com Clube de Benefícios -->
                            <div id="service-fee-savings" class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <!-- Será preenchido pelo JavaScript -->
                            </div>

                            <!-- Seção de Cupom de Desconto -->
                            <div id="coupon-section" class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                                    </svg>
                                    Cupom de Desconto
                                </h4>
                                <div class="flex space-x-2 mb-3">
                                    <input 
                                        type="text" 
                                        id="coupon-input" 
                                        placeholder="Digite o código do cupom" 
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                    >
                                    <button 
                                        id="apply-coupon-btn" 
                                        class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm font-medium"
                                    >
                                        Aplicar
                                    </button>
                                </div>
                                <div id="coupon-message" class="text-sm">
                                    <!-- Mensagem de sucesso/erro será exibida aqui -->
                                </div>
                                <div id="coupon-discount" class="hidden">
                                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">
                                        <div class="flex items-center">
                                            <span class="text-green-600 font-medium">Desconto do cupom</span>
                                            <span id="applied-coupon-code" class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded"></span>
                                        </div>
                                        <span id="coupon-discount-value" class="text-green-600 font-semibold">-R$ 0,00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Total -->
                            <div class="border-t pt-4 mt-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-bold text-gray-800">TOTAL</span>
                                    <span id="purchase-total" class="text-lg font-bold text-gray-800">R$ 1.020,00</span>
                                </div>
                                <div id="total-savings" class="text-sm text-gray-600 text-right mt-1">
                                    <!-- Será preenchido pelo JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botão de ação baseado no status da assinatura -->
                <div id="purchase-action-section">
                    <!-- Será preenchido pelo JavaScript -->
                </div>
            </main>
        </div>


        <!-- TELA DE CONQUISTAS (escondida por padrão) -->
        <div id="achievements-screen" class="hidden flex-col flex-grow">
            <header class="p-4 flex justify-between items-center border-b border-gray-200">
                <button id="back-to-profile-btn" class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-semibold text-gray-800">Conquistas</h1>
                <button class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4s-1.79 4-4 4c-1.742 0-3.223-.835-3.772-2M12 5v.01M12 19v.01M21 12h-.01M3 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
            </header>

            <main class="flex-grow p-4 bg-gray-50 overflow-y-auto no-scrollbar">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-800">Parcelas seguidas sem atraso</h2>
                    <p class="text-sm text-gray-500">Pague suas parcelas em dia para receber medalhas.</p>
                </div>

                <div id="main-progress-container" class="bg-white p-4 rounded-xl border border-gray-200 mb-6 transition-all">
                    <div id="completion-message" class="hidden items-center space-x-2 mb-2">
                        <svg class="h-6 w-6 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="text-green-700 font-semibold">Todas as medalhas da missão foram conquistadas</span>
                    </div>
                    <p id="main-progress-title" class="text-sm font-medium text-gray-600 mb-2">Até a próxima medalha</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                        <div id="main-progress-bar" class="bg-green-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="main-progress-text" class="text-right text-sm font-medium text-gray-500">0/4</p>
                </div>

                <div id="medal-grid" class="grid grid-cols-3 gap-4 text-center">
                    <!-- As medalhas serão preenchidas pelo JS -->
                </div>

                <div class="mt-8 text-center space-y-4">
                     <button id="advance-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Pagar Parcela (Simular)</button>
                     <button id="reset-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Resetar Simulação</button>
                </div>
            </main>
        </div>

        <!-- TELA DE CUPONS (escondida por padrão) -->
        <div id="cupons-screen" class="hidden flex-col flex-grow">
            <header class="p-4 flex justify-between items-center border-b border-gray-200">
                <button id="back-to-profile-from-cupons-btn" class="text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-semibold text-gray-800">Cupons</h1>
                <div class="w-6 h-6"></div>
            </header>
            <main class="flex-grow p-4 bg-gray-50 overflow-y-auto no-scrollbar">
                <div id="cupons-content" class="space-y-4">
                    <!-- O conteúdo será preenchido pelo JavaScript baseado no status do clube -->
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DO DOM ---
            const phoneScreen = document.getElementById('phone-screen');
            const otpScreen = document.getElementById('otp-screen');
            const profileScreen = document.getElementById('profile-screen');
            const achievementsScreen = document.getElementById('achievements-screen');
            const benefitsScreen = document.getElementById('benefits-screen');
            const activeSubscriptionScreen = document.getElementById('active-subscription-screen');
            const plansScreen = document.getElementById('plans-screen');
            const paymentScreen = document.getElementById('payment-screen');
            const purchaseSimulationScreen = document.getElementById('purchase-simulation-screen');
            const showAchievementsBtn = document.getElementById('show-achievements-btn');
            const clubeBeneficiosBtn = document.getElementById('clube-beneficios-btn');
            const cuponsScreen = document.getElementById('cupons-screen');
            const cuponsBtn = document.getElementById('cupons-btn');
            const simularCompraBtn = document.getElementById('simular-compra-btn');
            const backToProfileBtn = document.getElementById('back-to-profile-btn');
            const backToProfileFromBenefitsBtn = document.getElementById('back-to-profile-from-benefits-btn');
            const backToProfileFromActiveBtn = document.getElementById('back-to-profile-from-active-btn');
            const backToProfileFromPurchaseBtn = document.getElementById('back-to-profile-from-purchase-btn');
            const backToProfileFromCuponsBtn = document.getElementById('back-to-profile-from-cupons-btn');
            const backToBenefitsBtn = document.getElementById('back-to-benefits-btn');
            const backToPlansBtn = document.getElementById('back-to-plans-btn');
            const subscribeBtn = document.getElementById('subscribe-btn');
            const continueToPaymentBtn = document.getElementById('continue-to-payment-btn');
            const simulatePaymentBtn = document.getElementById('simulate-payment-btn');
            const planOptions = document.querySelectorAll('.plan-option');
            const selectedPlanSummary = document.getElementById('selected-plan-summary');
            const paymentTotal = document.getElementById('payment-total');
            const subscriptionDetails = document.getElementById('subscription-details');
            const cancelSubscriptionBtn = document.getElementById('cancel-subscription-btn');
            const cashbackInfo = document.getElementById('cashback-info');
            const purchaseActionSection = document.getElementById('purchase-action-section');
            const serviceFeeSavings = document.getElementById('service-fee-savings');
            const totalSavings = document.getElementById('total-savings');
            const cashbackBalance = document.getElementById('cashback-balance');
            const advanceBtn = document.getElementById('advance-btn');
            const resetBtn = document.getElementById('reset-btn');
            const medalGrid = document.getElementById('medal-grid');
            const mainProgressBar = document.getElementById('main-progress-bar');
            const mainProgressText = document.getElementById('main-progress-text');
            const mainProgressContainer = document.getElementById('main-progress-container');
            const mainProgressTitle = document.getElementById('main-progress-title');
            const completionMessage = document.getElementById('completion-message');
            const medalsUnlockedCount = document.getElementById('medals-unlocked-count');
            const medalsTotalCount = document.getElementById('medals-total-count');
            
            // Elementos das telas de OTP
            const phoneInput = document.getElementById('phone-input');
            const sendOtpBtn = document.getElementById('send-otp-btn');
            const phoneError = document.getElementById('phone-error');
            const backToPhoneBtn = document.getElementById('back-to-phone-btn');
            const phoneDisplay = document.getElementById('phone-display');
            const otpInputs = document.querySelectorAll('.otp-input');
            const verifyOtpBtn = document.getElementById('verify-otp-btn');
            const resendOtpBtn = document.getElementById('resend-otp-btn');
            const otpError = document.getElementById('otp-error');
            const logoutBtn = document.getElementById('logout-btn');

            // --- ESTADO DA SIMULAÇÃO ---
            let currentProgress = 0; // Será inicializado após STORAGE_KEYS
            const MAX_PROGRESS = 100;
            let selectedPlan = null;
            
            // --- ESTADO DO OTP ---
            let currentPhone = '';
            let otpCode = '';
            
            // --- FUNÇÕES DE AUTENTICAÇÃO ---
            const isTokenValid = () => {
                const token = localStorage.getItem('pagaleve_token');
                const expiration = localStorage.getItem('pagaleve_token_expiration');
                
                if (!token || !expiration) return false;
                
                const now = new Date();
                const expirationDate = new Date(expiration);
                
                return now < expirationDate;
            };
            
            const logout = () => {
                // Limpar todos os dados de autenticação e usuário
                localStorage.removeItem('pagaleve_authenticated');
                localStorage.removeItem('pagaleve_phone');
                localStorage.removeItem('pagaleve_token');
                localStorage.removeItem('pagaleve_refresh_token');
                localStorage.removeItem('pagaleve_token_expiration');
                localStorage.removeItem('pagaleve_customer_data');
                
                // Voltar para tela de telefone
                profileScreen.classList.add('hidden');
                otpScreen.classList.add('hidden');
                phoneScreen.classList.remove('hidden');
                
                // Limpar campos
                phoneInput.value = '';
                otpInputs.forEach(input => input.value = '');
                
                console.log('🚪 Logout realizado com sucesso');
            };
            

            // Função para inicializar conquistas baseadas no número de planos pagos
            const initializeAchievementsFromPaidPlans = (paidPlansCount) => {
                console.log(`🏅 Inicializando conquistas com base em ${paidPlansCount} planos pagos`);
                
                // Atualizar o array de medalhas global com base nos planos pagos
                medals.forEach(medal => {
                    if (paidPlansCount >= medal.goal) {
                        medal.unlocked = true;
                    }
                });
                
                // Salvar medalhas atualizadas
                saveToStorage(STORAGE_KEYS.MEDALS, medals);
                
                // Atualizar interface das medalhas
                renderMedals();
                updateMedalsSummary();
                
                const unlockedCount = medals.filter(medal => medal.unlocked).length;
                console.log(`🎖️ ${unlockedCount} medalhas desbloqueadas baseadas em ${paidPlansCount} planos pagos`);
            };

            const getCustomerData = async (token) => {
                try {
                    console.log('👤 Buscando dados do usuário...');
                    
                    const response = await fetch('https://customer-graphql-api.pagaleve.com.br/graphql', {
                        method: 'POST',
                        headers: {
                            'Authorization': token,
                            'Referer': 'https://wallet.pagaleve.com.br/',
                            'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1',
                            'accept': '*/*',
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            operationName: "getCustomerLogged",
                            variables: {},
                            query: `query getCustomerLogged {
                                getCustomerLogged {
                                    address {
                                        city
                                        complement
                                        id
                                        number
                                        postal_code
                                        state
                                        street
                                        __typename
                                    }
                                    birth_date
                                    country
                                    email
                                    id
                                    individual_id
                                    name
                                    phone
                                    status
                                    timestamp
                                    user_id
                                    __typename
                                }
                            }`
                        })
                    });

                    const data = await response.json();
                    
                    if (data.errors) {
                        throw new Error(data.errors[0].message || 'Erro ao buscar dados do usuário');
                    }

                    const customerData = data.data.getCustomerLogged;
                    
                    if (customerData) {
                        console.log('✅ Dados do usuário obtidos com sucesso:');
                        console.log('👤 Nome:', customerData.name);
                        console.log('📧 Email:', customerData.email);
                        console.log('📱 Telefone:', customerData.phone);
                        console.log('🆔 ID:', customerData.id);
                        console.log('🏠 Endereço:', customerData.address);
                        console.log('📅 Data de nascimento:', customerData.birth_date);
                        console.log('🌍 País:', customerData.country);
                        
                        // Salvar dados do usuário no localStorage
                        localStorage.setItem('pagaleve_customer_data', JSON.stringify(customerData));
                        
                        // Atualizar interface com nome do usuário
                        updateUserInterface(customerData);
                        
                        return customerData;
                    } else {
                        throw new Error('Dados do usuário não encontrados');
                    }

                } catch (error) {
                    console.error('❌ Erro ao buscar dados do usuário:', error);
                    return null;
                }
            };
            
            const updateUserInterface = (customerData) => {
                // Atualizar elementos da interface que mostram informações do usuário
                if (customerData.name) {
                    const firstName = customerData.name.split(' ')[0];
                    const userDisplayName = `${firstName} (Você)`;
                    
                    // Procurar por elementos que podem mostrar o nome do usuário
                    const nameElements = document.querySelectorAll('[data-user-name]');
                    nameElements.forEach(element => {
                        element.textContent = customerData.name;
                    });
                    
                    // Atualizar título ou saudação se existir
                    const greetingElements = document.querySelectorAll('.user-greeting');
                    greetingElements.forEach(element => {
                        element.textContent = `Olá, ${firstName}!`;
                    });
                    
                    // Atualizar o nome no perfil da economia total (se existir)
                    const profileNameElement = document.querySelector('.profile-user-name');
                    if (profileNameElement) {
                        profileNameElement.textContent = userDisplayName;
                    }
                    
                }
            };
            
            
            // --- SISTEMA DE PERSISTÊNCIA COM LOCALSTORAGE ---
            const STORAGE_KEYS = {
                USER_DATA: 'pagaleve_user_data',
                SUBSCRIPTION: 'pagaleve_subscription',
                CASHBACK: 'pagaleve_cashback',
                CUPONS: 'pagaleve_cupons',
                ECONOMIA_TOTAL: 'pagaleve_economia_total',
                MEDALS: 'pagaleve_medals',
                PROGRESS: 'pagaleve_progress'
            };

            // Função para carregar dados do localStorage
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : defaultValue;
                } catch (e) {
                    console.warn(`Erro ao carregar ${key} do localStorage:`, e);
                    return defaultValue;
                }
            };

            // Função para salvar dados no localStorage
            const saveToStorage = (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn(`Erro ao salvar ${key} no localStorage:`, e);
                }
            };

            // Para facilitar o desenvolvimento, expõe no console
            window.debugStorage = () => {
                console.log('=== ESTADO ATUAL DO LOCALSTORAGE ===');
                console.log('Subscription:', loadFromStorage(STORAGE_KEYS.SUBSCRIPTION, null));
                console.log('Cashback:', loadFromStorage(STORAGE_KEYS.CASHBACK, null));
                console.log('Cupons:', loadFromStorage(STORAGE_KEYS.CUPONS, null));
                console.log('Economia Total:', loadFromStorage(STORAGE_KEYS.ECONOMIA_TOTAL, null));
                console.log('Medals:', loadFromStorage(STORAGE_KEYS.MEDALS, null));
                console.log('Progress:', loadFromStorage(STORAGE_KEYS.PROGRESS, null));
                console.log('===================================');
            };
            window.addTestCashback = () => addCashback(50, 'Teste de cashback');
            window.testCouponUsage = (couponId) => useCoupon(couponId);
            window.addTestEconomia = () => {
                console.log('🧪 Testando economia - valor antes:', economiaTotal);
                const result = addEconomiaTotal(4, 10, 'Teste de economia');
                console.log('🧪 Testando economia - valor depois:', economiaTotal);
                console.log('🧪 Resultado:', result);
                return result;
            };
            window.getEconomiaData = () => getEconomiaTotalAcumulada();
            window.forceUpdateEconomia = () => {
                console.log('🔄 Forçando atualização da economia total:', economiaTotal);
                updateEconomiaTotalValor();
            };
            window.testUnsubscribedMode = () => {
                isSubscribed = false;
                activeSubscription = { active: false, plan: null, startDate: null, endDate: null };
                updateSubscriptionUI();
                console.log('🧪 Modo não assinado ativado - agora você pode testar o botão "Simular compra"');
            };
            window.testUseCoupon = (couponId = 1) => {
                if (isSubscribed) {
                    const success = useCoupon(couponId);
                    if (success) {
                        updateCuponsSection(); // Vai atualizar automaticamente a visualização
                        console.log(`🎫 Cupom ${couponId} usado com sucesso! Cupons restantes: ${getAvailableCoupons().length}`);
                    } else {
                        console.log('❌ Cupom não encontrado ou já foi usado');
                    }
                } else {
                    console.log('❌ Você precisa estar no clube para usar cupons');
                }
            };
            window.testSubscribedMode = () => {
                isSubscribed = true;
                activeSubscription = { active: true, plan: 'mensal', startDate: new Date().toISOString(), endDate: new Date(Date.now() + 30*24*60*60*1000).toISOString() };
                updateSubscriptionUI();
                console.log('🧪 Modo assinado ativado - agora você pode testar os cupons dinâmicos');
                console.log('🎫 Use testUseCoupon(1) para usar um cupom e ver a visualização mudar');
            };

            // --- ESTADO DA ASSINATURA ---
            let isSubscribed = loadFromStorage(STORAGE_KEYS.SUBSCRIPTION, { active: false, plan: null, startDate: null, endDate: null }).active;
            let activeSubscription = loadFromStorage(STORAGE_KEYS.SUBSCRIPTION, { active: false, plan: null, startDate: null, endDate: null });
            // --- SISTEMA DE CASHBACK COM LOCALSTORAGE ---
            let cashbackData = loadFromStorage(STORAGE_KEYS.CASHBACK, { balance: 0, history: [] });
            let cashbackBalanceAmount = cashbackData.balance;
            
            
            // --- SISTEMA DE ECONOMIA TOTAL COM LOCALSTORAGE ---
            let economiaData = loadFromStorage(STORAGE_KEYS.ECONOMIA_TOTAL, { 
                totalAcumulado: 0, 
                economiaTaxaServico: 0, 
                economiaCashback: 0, 
                history: [] 
            });
            let economiaTotal = economiaData.totalAcumulado;
            
            // --- ESTADO DO CUPOM NA COMPRA ---
            let appliedCoupon = null; // Cupom aplicado na compra atual
            
            // --- ESTADO DA SIMULAÇÃO DE COMPRA ---
            // Removido o estado do expansor

            // --- DEFINIÇÕES DAS MEDALHAS COM LOCALSTORAGE ---
            const defaultMedals = [
                { goal: 1,  unlocked: false, color: 'bg-green-400', ribbon: '#34D399' },
                { goal: 5,  unlocked: false, color: 'bg-purple-400', ribbon: '#A78BFA' },
                { goal: 10, unlocked: false, color: 'bg-blue-400', ribbon: '#60A5FA' },
                { goal: 20, unlocked: false, color: 'bg-yellow-400', ribbon: '#FBBF24' },
                { goal: 50, unlocked: false, color: 'bg-red-400', ribbon: '#F87171' },
                { goal: 100, unlocked: false, color: 'bg-teal-400', ribbon: '#2DD4BF' },
            ];
            
            let medals = defaultMedals; // Será inicializado após STORAGE_KEYS

            // --- DEFINIÇÕES DOS CUPONS ---
            const defaultCupons = [
                { 
                    id: 1, 
                    title: 'R$ 15 OFF', 
                    description: 'Em compras acima de R$ 200', 
                    code: 'SAVE15A', 
                    expiration: '31/08/2025',
                    value: 15,
                    minValue: 200
                },
                { 
                    id: 2, 
                    title: 'R$ 15 OFF', 
                    description: 'Em compras acima de R$ 200', 
                    code: 'SAVE15B', 
                    expiration: '31/08/2025',
                    value: 15,
                    minValue: 200
                },
                { 
                    id: 3, 
                    title: 'R$ 15 OFF', 
                    description: 'Em compras acima de R$ 200', 
                    code: 'SAVE15C', 
                    expiration: '31/08/2025',
                    value: 15,
                    minValue: 200
                },
                { 
                    id: 4, 
                    title: 'R$ 15 OFF', 
                    description: 'Em compras acima de R$ 200', 
                    code: 'SAVE15D', 
                    expiration: '31/08/2025',
                    value: 15,
                    minValue: 200
                }
            ];

            // --- SISTEMA DE CUPONS COM LOCALSTORAGE ---
            let cupons = loadFromStorage(STORAGE_KEYS.CUPONS, {
                available: [...defaultCupons],
                used: []
            });

            // Funcões para gerenciar cupons
            const saveCupons = () => {
                saveToStorage(STORAGE_KEYS.CUPONS, cupons);
            };

            const useCoupon = (couponId) => {
                const couponIndex = cupons.available.findIndex(c => c.id === couponId);
                if (couponIndex !== -1) {
                    const usedCoupon = cupons.available.splice(couponIndex, 1)[0];
                    cupons.used.push({
                        ...usedCoupon,
                        usedAt: new Date().toISOString()
                    });
                    saveCupons();
                    return true;
                }
                return false;
            };

            const getAvailableCoupons = () => cupons.available;
            const getUsedCoupons = () => cupons.used;

            const consumeCoupon = (couponCode) => {
                const coupon = cupons.available.find(c => c.code.toUpperCase() === couponCode.toUpperCase());
                if (coupon) {
                    return useCoupon(coupon.id);
                }
                return false;
            };

            const resetCouponSection = () => {
                const couponInput = document.getElementById('coupon-input');
                const couponMessage = document.getElementById('coupon-message');
                const couponDiscount = document.getElementById('coupon-discount');
                
                if (couponInput) couponInput.value = '';
                if (couponMessage) couponMessage.innerHTML = '';
                if (couponDiscount) couponDiscount.classList.add('hidden');
                
                appliedCoupon = null;
                
                // Atualiza a economia total e o total da compra
                updateTotalSavings();
                updatePurchaseTotal();
            };

            // --- SVGs ---
            const lockedIconSVG = `
                <div class="w-16 h-16 flex items-center justify-center bg-gray-100 rounded-full mb-2 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>`;

            const unlockedIconSVG = (color, ribbon) => `
                <div class="w-16 h-16 flex items-center justify-center rounded-full mb-2 transition-all ${color}">
                    <svg width="50" height="50" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4.75 19V11.0833C4.75 11.0833 4.75 6.33333 9.5 4.75C14.25 3.16667 19 6.33333 19 6.33333C19 6.33333 23.75 3.16667 28.5 4.75C33.25 6.33333 33.25 11.0833 33.25 11.0833V19C33.25 26.9167 19 34.8333 19 34.8333C19 34.8333 4.75 26.9167 4.75 19Z" fill="${ribbon}"/>
                        <path d="M19.0002 24.3333C22.1164 24.3333 24.6668 21.8229 24.6668 18.75C24.6668 15.6771 22.1164 13.1667 19.0002 13.1667C15.8839 13.1667 13.3335 15.6771 13.3335 18.75C13.3335 21.8229 15.8839 24.3333 19.0002 24.3333Z" fill="white"/>
                        <path d="M19 16.5833V20.9167M19 20.9167C19.9868 20.9167 21.3333 20.4271 21.3333 18.75C21.3333 17.0729 19.9868 16.5833 19 16.5833M19 20.9167C18.0132 20.9167 16.6667 20.4271 16.6667 18.75C16.6667 17.0729 18.0132 16.5833 19 16.5833M19 16.5833L19.7917 15.4167M19 16.5833L18.2083 15.4167M19 20.9167L18.2083 22.0833M19 20.9167L19.7917 22.0833" stroke="#${ribbon.substring(1)}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>`;

            // --- FUNÇÕES DE OTP ---
            let lastPhoneValue = '';
            
            const formatPhoneNumber = (value) => {
                // Remove tudo exceto números
                const numbers = value.replace(/\D/g, '');
                
                if (numbers.length === 0) return '';
                if (numbers.length <= 2) return `+${numbers}`;
                if (numbers.length <= 4) return `+${numbers.slice(0, 2)} (${numbers.slice(2)}`;
                if (numbers.length <= 6) return `+${numbers.slice(0, 2)} (${numbers.slice(2, 4)}) ${numbers.slice(4)}`;
                if (numbers.length <= 10) return `+${numbers.slice(0, 2)} (${numbers.slice(2, 4)}) ${numbers.slice(4, 9)}-${numbers.slice(9)}`;
                return `+${numbers.slice(0, 2)} (${numbers.slice(2, 4)}) ${numbers.slice(4, 9)}-${numbers.slice(9, 13)}`;
            };
            
            const handlePhoneInput = (e) => {
                const input = e.target;
                const currentValue = input.value;
                const cursorPos = input.selectionStart;
                
                // Extrair apenas números do valor atual e anterior
                const currentNumbers = currentValue.replace(/\D/g, '');
                const lastNumbers = lastPhoneValue.replace(/\D/g, '');
                
                // Detectar se está deletando
                const isDeleting = currentNumbers.length < lastNumbers.length;
                
                // Se estiver deletando e o cursor estiver numa posição de caractere especial,
                // permitir que delete o número anterior também
                if (isDeleting && cursorPos > 0) {
                    const charBeforeCursor = currentValue[cursorPos - 1];
                    if (['-', '(', ')', ' '].includes(charBeforeCursor)) {
                        // Remove o último número também
                        const newNumbers = currentNumbers.slice(0, -1);
                        const formatted = formatPhoneNumber(newNumbers);
                        input.value = formatted;
                        lastPhoneValue = formatted;
                        
                        // Posicionar cursor no final
                        setTimeout(() => {
                            input.setSelectionRange(formatted.length, formatted.length);
                        }, 0);
                        
                        sendOtpBtn.disabled = !isValidPhone(formatted);
                        return;
                    }
                }
                
                // Formatação normal
                const formatted = formatPhoneNumber(currentValue);
                input.value = formatted;
                lastPhoneValue = formatted;
                
                // Manter posição do cursor aproximada
                if (!isDeleting && formatted.length > cursorPos) {
                    setTimeout(() => {
                        input.setSelectionRange(formatted.length, formatted.length);
                    }, 0);
                }
                
                sendOtpBtn.disabled = !isValidPhone(formatted);
            };

            const isValidPhone = (phone) => {
                const numbers = phone.replace(/\D/g, '');
                // Valida se tem 13 dígitos (código país + DDD + celular com 9 dígitos)
                return numbers.length === 13;
            };

            const showError = (element, message) => {
                element.textContent = message;
                element.classList.remove('hidden');
                setTimeout(() => element.classList.add('hidden'), 5000);
            };


            const initiatePhoneAuth = async (phone) => {
                const cleanPhone = phone.replace(/\D/g, '');
                const formattedPhone = `+${cleanPhone}`;

                try {
                    sendOtpBtn.disabled = true;
                    sendOtpBtn.textContent = 'Enviando...';

                    const response = await fetch('https://public-graphql-api.pagaleve.com.br/graphql', {
                        method: 'POST',
                        headers: {
                            'accept': '*/*',
                            'accept-language': 'en-US,en;q=0.9',
                            'content-type': 'application/json',
                            'origin': 'https://wallet.pagaleve.com.br',
                            'referer': 'https://wallet.pagaleve.com.br/',
                            'x-api-key': 'da2-fgzcqsr6hvgcxmdzjouht2fmfq',
                            'user-agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'
                        },
                        body: JSON.stringify({
                            operationName: "initiatePhoneAuth",
                            variables: {
                                phone: formattedPhone,
                                sendBySms: true,
                                sendByWhatsapp: true,
                                forceOtp: true
                            },
                            query: `mutation initiatePhoneAuth($phone: String!, $forceOtp: Boolean, $checkoutId: String, $sendByWhatsapp: Boolean, $sendBySms: Boolean, $sendByEmail: Boolean) {
                                initiatePhoneAuth(
                                    phone: $phone
                                    forceOtp: $forceOtp
                                    checkoutId: $checkoutId
                                    sendByWhatsapp: $sendByWhatsapp
                                    sendBySms: $sendBySms
                                    sendByEmail: $sendByEmail
                                ) {
                                    has_password
                                    phone
                                    __typename
                                }
                            }`
                        })
                    });

                    const data = await response.json();
                    
                    if (data.errors) {
                        throw new Error(data.errors[0].message || 'Erro ao enviar código');
                    }

                    currentPhone = formattedPhone;
                    phoneDisplay.textContent = phone;
                    
                    // Ocultar tela de telefone e mostrar tela de OTP
                    phoneScreen.classList.add('hidden');
                    otpScreen.classList.remove('hidden');
                    otpInputs[0].focus();

                } catch (error) {
                    console.error('Erro ao iniciar autenticação:', error);
                    showError(phoneError, 'Erro ao enviar código. Tente novamente.');
                } finally {
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.textContent = 'Enviar código';
                }
            };

            const verifyOtp = async (code) => {
                try {
                    verifyOtpBtn.disabled = true;
                    verifyOtpBtn.textContent = 'Verificando...';

                    const response = await fetch('https://public-graphql-api.pagaleve.com.br/graphql', {
                        method: 'POST',
                        headers: {
                            'accept': '*/*',
                            'accept-language': 'en-US,en;q=0.9',
                            'content-type': 'application/json',
                            'origin': 'https://wallet.pagaleve.com.br',
                            'referer': 'https://wallet.pagaleve.com.br/',
                            'x-api-key': 'da2-fgzcqsr6hvgcxmdzjouht2fmfq',
                            'user-agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'
                        },
                        body: JSON.stringify({
                            operationName: "loginByCode",
                            variables: {
                                code: code,
                                phone: currentPhone
                            },
                            query: `mutation loginByCode($phone: String!, $code: String!, $input: SignupOriginInput) {
                                loginByCode(phone: $phone, code: $code, input: $input) {
                                    expiration_date
                                    token
                                    refresh_token
                                    __typename
                                }
                            }`
                        })
                    });

                    const data = await response.json();
                    
                    if (data.errors) {
                        throw new Error(data.errors[0].message || 'Código inválido');
                    }

                    const loginData = data.data.loginByCode;
                    
                    if (loginData && loginData.token) {
                        // Log do token no console para uso posterior
                        console.log('🎉 Login realizado com sucesso!');
                        console.log('📱 Telefone:', currentPhone);
                        console.log('🔑 Token:', loginData.token);
                        console.log('🔄 Refresh Token:', loginData.refresh_token);
                        console.log('⏰ Expiration Date:', loginData.expiration_date);
                        
                        // Salvar dados de autenticação no localStorage
                        localStorage.setItem('pagaleve_authenticated', 'true');
                        localStorage.setItem('pagaleve_phone', currentPhone);
                        localStorage.setItem('pagaleve_token', loginData.token);
                        localStorage.setItem('pagaleve_refresh_token', loginData.refresh_token);
                        localStorage.setItem('pagaleve_token_expiration', loginData.expiration_date);
                        
                        // Buscar dados do usuário
                        await getCustomerData(loginData.token);
                        
                        // Ir para a tela principal
                        otpScreen.classList.add('hidden');
                        profileScreen.classList.remove('hidden');
                        
                        // Atualiza a interface
                        updateEconomiaTotalValor();
                    } else {
                        throw new Error('Resposta inválida da API');
                    }

                } catch (error) {
                    console.error('Erro ao verificar OTP:', error);
                    showError(otpError, error.message || 'Código inválido. Tente novamente.');
                    // Limpar campos OTP
                    otpInputs.forEach(input => input.value = '');
                    otpInputs[0].focus();
                } finally {
                    verifyOtpBtn.disabled = false;
                    verifyOtpBtn.textContent = 'Confirmar';
                }
            };

            // --- FUNÇÃO DE NOTIFICAÇÃO WHATSAPP ---
            const sendWhatsAppNotification = async (planName, planPrice) => {
                try {
                    // Configurações da notificação - podem ser personalizadas conforme necessário
                    const notificationConfig = {
                        phone_number: "+5513996858433", // Pode ser alterado para o telefone real do usuário
                        customer_id: `customer-${Date.now()}`, // ID único do cliente
                        email: "demo@pagaleve.com.br", // Email do usuário
                        api_key: window.TOKEN_NOTIFICATION || "abc123" // Chave da API de variável global
                    };

                    const payload = {
                        phone_number: notificationConfig.phone_number,
                        customer_id: notificationConfig.customer_id,
                        pagaleve_event_id: `plan-activation-${Date.now()}`,
                        email: notificationConfig.email,
                        message_code: "wpp_download_app_v3",
                        type: "MARKETING",
                        template_id: "HX219d85a0701cbaf71e25a2967a012b2f",
                        plan_details: {
                            name: planName,
                            price: planPrice,
                            activation_date: new Date().toISOString()
                        }
                    };

                    console.log('📱 Enviando notificação WhatsApp...', payload);

                    const response = await fetch('https://external-api.pagaleve.com.br/v1/webhooks/send-whatsapp', {
                        method: 'POST',
                        headers: {
                            'x-api-key': notificationConfig.api_key,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        console.log('✅ Notificação WhatsApp enviada com sucesso!');
                        const result = await response.json();
                        console.log('📄 Resposta da API:', result);
                    } else {
                        const errorText = await response.text();
                        console.log('⚠️ Erro ao enviar notificação WhatsApp:', response.status, errorText);
                    }
                } catch (error) {
                    console.log('❌ Falha no envio da notificação WhatsApp:', error);
                    // Em um ambiente de produção, você pode querer registrar este erro em um sistema de monitoramento
                }
            };

            // --- FUNÇÕES DE ASSINATURA ---
            const updateSubscriptionDetails = () => {
                if (!activeSubscription || !activeSubscription.active) return;
                
                const planNames = {1: 'Mensal', 3: 'Trimestral', 6: 'Semestral'};
                const startDate = new Date(activeSubscription.startDate);
                const endDate = new Date(activeSubscription.endDate);
             
                
                monthsRemaining = Math.max(0, activeSubscription.months);
                
                subscriptionDetails.innerHTML = `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-gray-600">Plano</span>
                        <span class="font-semibold">${planNames[activeSubscription.months]}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-gray-600">Valor pago</span>
                        <span class="font-semibold">R$ ${activeSubscription.price.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-gray-600">Início da assinatura</span>
                        <span class="font-semibold">${startDate.toLocaleDateString('pt-BR')}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-gray-600">Próxima renovação</span>
                        <span class="font-semibold">${endDate.toLocaleDateString('pt-BR')}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600">Tempo restante</span>
                        <span class="font-semibold text-green-600">${monthsRemaining} ${monthsRemaining !== 1 ? 'mêses' : 'mes'}</span>
                    </div>
                `;
            };
            
            const activateSubscription = (plan) => {
                isSubscribed = true;
                const startDate = new Date();
                const endDate = new Date();
                endDate.setMonth(endDate.getMonth() + plan.months);
                
                activeSubscription = {
                    ...plan,
                    active: true,
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString()
                };
                
                // Salva no localStorage
                saveToStorage(STORAGE_KEYS.SUBSCRIPTION, activeSubscription);
                
                updateSubscriptionDetails();
                updateSubscriptionUI();
                
                // Envia notificação WhatsApp
                const planNames = {1: 'Mensal', 3: 'Trimestral', 6: 'Semestral'};
                const planName = planNames[plan.months] || 'Personalizado';
                sendWhatsAppNotification(planName, plan.price);
            };
            
            const cancelSubscription = () => {
                if (confirm('Tem certeza de que deseja cancelar sua assinatura?\n\nVocê perderá todos os benefícios do Clube de Benefícios imediatamente.')) {
                    // Reset do estado da assinatura
                    isSubscribed = false;
                    activeSubscription = { active: false, plan: null, startDate: null, endDate: null };
                    
                    // Salva no localStorage
                    saveToStorage(STORAGE_KEYS.SUBSCRIPTION, activeSubscription);
                    
                    // Reset das seleções de plano
                    selectedPlan = null;
                    planOptions.forEach(opt => {
                        opt.classList.remove('border-purple-500', 'bg-purple-50');
                        opt.classList.add('border-gray-200');
                    });
                    continueToPaymentBtn.disabled = true;
                    continueToPaymentBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    continueToPaymentBtn.classList.remove('opacity-100', 'cursor-pointer');
                    
                    // Limpa detalhes da assinatura
                    subscriptionDetails.innerHTML = '';
                    selectedPlanSummary.innerHTML = '';
                    paymentTotal.textContent = 'R$ 0,00';
                    
                    // Volta para o perfil
                    activeSubscriptionScreen.classList.add('hidden');
                    activeSubscriptionScreen.classList.remove('flex');
                    profileScreen.classList.remove('hidden');
                    
                    // Atualiza o saldo de cashback e UI
                    updateSubscriptionUI();
                    
                    alert('Assinatura cancelada com sucesso.\n\nSeus benefícios foram desativados. Você pode reativar a qualquer momento!');
                }
            };
            
            // --- FUNÇÕES DE CASHBACK ---
            const updateCashbackBalance = () => {
                if (isSubscribed) {
                    cashbackBalance.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-4 0h-4v-1h4m0 10v1h4v-1m-4 0h-4v1h4" />
                        </svg>
                        <span class="text-sm font-medium text-green-600">Cashback: R$ ${cashbackBalanceAmount.toFixed(2)}</span>
                    `;
                } else {
                    cashbackBalance.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-4 0h-4v-1h4m0 10v1h4v-1m-4 0h-4v1h4" />
                        </svg>
                        <span class="text-sm text-gray-500">Cashback: R$ 0,00</span>
                    `;
                }
            };
            
            const saveCashback = () => {
                cashbackData.balance = cashbackBalanceAmount;
                saveToStorage(STORAGE_KEYS.CASHBACK, cashbackData);
            };

            const addCashback = (amount, description = 'Cashback recebido') => {
                if (isSubscribed) {
                    cashbackBalanceAmount += amount;
                    
                    // Adiciona ao histórico
                    cashbackData.history.push({
                        amount: amount,
                        description: description,
                        date: new Date().toISOString(),
                        type: 'credit'
                    });
                    
                    saveCashback();
                    updateCashbackBalance();
                    updateCashbackDisponivel();
                    return true;
                }
                return false;
            };

            const useCashback = (amount, description = 'Cashback usado') => {
                if (isSubscribed && cashbackBalanceAmount >= amount) {
                    cashbackBalanceAmount -= amount;
                    
                    // Adiciona ao histórico
                    cashbackData.history.push({
                        amount: -amount,
                        description: description,
                        date: new Date().toISOString(),
                        type: 'debit'
                    });
                    
                    saveCashback();
                    updateCashbackBalance();
                    updateCashbackDisponivel();
                    return true;
                }
                return false;
            };

            const getCashbackHistory = () => {
                return cashbackData.history.slice().reverse(); // Retorna histórico ordenado por data (mais recente primeira)
            };

            // --- FUNÇÕES DE ECONOMIA TOTAL ---
            const saveEconomiaTotal = () => {
                economiaData.totalAcumulado = economiaTotal;
                saveToStorage(STORAGE_KEYS.ECONOMIA_TOTAL, economiaData);
            };

            const addEconomiaTotal = (economiaTaxa, economiaCashback, description = 'Economia em compra') => {
                if (isSubscribed) {
                    const economiaCompra = economiaTaxa + economiaCashback;
                    economiaTotal += economiaCompra;
                    
                    // Adiciona ao histórico
                    economiaData.history.push({
                        economiaTaxaServico: economiaTaxa,
                        economiaCashback: economiaCashback,
                        economiaTotal: economiaCompra,
                        description: description,
                        date: new Date().toISOString(),
                        type: 'economia'
                    });
                    
                    // Atualiza valores separados
                    economiaData.economiaTaxaServico += economiaTaxa;
                    economiaData.economiaCashback += economiaCashback;
                    
                    saveEconomiaTotal();
                    updateEconomiaTotalValor();
                    return true;
                }
                return false;
            };

            const getEconomiaHistory = () => {
                return economiaData.history.slice().reverse(); // Retorna histórico ordenado por data (mais recente primeira)
            };

            const getEconomiaTotalAcumulada = () => {
                return {
                    total: economiaTotal,
                    taxaServico: economiaData.economiaTaxaServico,
                    cashback: economiaData.economiaCashback
                };
            };

            // --- FUNÇÕES DE ATUALIZAÇÃO DE INTERFACE ---
            const updateSubscriptionStatus = () => {
                const subscriptionStatus = document.getElementById('subscription-status');
                if (isSubscribed) {
                    subscriptionStatus.innerHTML = `<span>Ativo</span>`;
                } else {
                    subscriptionStatus.innerHTML = `<span>Inativo</span>`;
                }
            };

            const updateSubscriptionActionBtn = () => {
                const buttonsContainer = document.getElementById('subscription-buttons-container');
                
                if (isSubscribed) {
                    // Para usuários assinados: dois botões lado a lado
                    buttonsContainer.innerHTML = `
                        <div class="flex space-x-3">
                            <button id="faca-compra-btn" class="flex-1 bg-green-500 text-white font-medium py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">
                                Faça uma compra
                            </button>
                            <button id="ver-beneficios-btn" class="flex-1 bg-white border border-purple-500 text-purple-500 font-medium py-3 px-4 rounded-lg hover:bg-purple-50 transition-colors">
                                Ver meus benefícios
                            </button>
                        </div>
                    `;
                    
                    // Event listeners para os novos botões
                    document.getElementById('faca-compra-btn').onclick = () => {
                        profileScreen.classList.add('hidden');
                        purchaseSimulationScreen.classList.remove('hidden');
                        purchaseSimulationScreen.classList.add('flex');
                        updateCouponSectionVisibility();
                        setupCouponEventListeners();
                        updatePurchaseTotal();
                    };
                    
                    document.getElementById('ver-beneficios-btn').onclick = () => {
                        profileScreen.classList.add('hidden');
                        activeSubscriptionScreen.classList.remove('hidden');
                        activeSubscriptionScreen.classList.add('flex');
                    };
                } else {
                    // Para usuários não assinados: dois botões lado a lado
                    buttonsContainer.innerHTML = `
                        <div class="grid grid-cols-2 gap-3">
                            <button id="subscription-action-btn" class="bg-purple-500 text-white font-medium py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors">
                                Assine seu plano
                            </button>
                            <button id="simulate-purchase-btn" class="bg-gray-500 text-white font-medium py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                Simular compra
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('subscription-action-btn').onclick = () => {
                        profileScreen.classList.add('hidden');
                        benefitsScreen.classList.remove('hidden');
                        benefitsScreen.classList.add('flex');
                    };
                    
                    document.getElementById('simulate-purchase-btn').onclick = () => {
                        profileScreen.classList.add('hidden');
                        purchaseSimulationScreen.classList.remove('hidden');
                        purchaseSimulationScreen.classList.add('flex');
                        updateCashbackInfo();
                        updateServiceFeeSavings();
                        updateTotalSavings();
                        updatePurchaseActionSection();
                        updateCouponSectionVisibility();
                        setupCouponEventListeners();
                        updatePurchaseTotal();
                    };
                }
            };

            const updateCuponsVisual = () => {
                const cuponsVisualContainer = document.getElementById('cupons-visual-container');
                const rotations = [12, -6, 3, -12, 6, 9, -9, 15, -3]; // Rotações variadas
                
                let cuponsToShow;
                if (isSubscribed) {
                    // Usuário ativo: mostra quantidade real de cupons disponíveis
                    cuponsToShow = getAvailableCoupons().length;
                } else {
                    // Usuário não ativo: mostra apenas 4 cupons
                    cuponsToShow = 4;
                }
                
                let cuponsHtml = '';
                for (let i = 0; i < cuponsToShow; i++) {
                    const rotation = rotations[i % rotations.length];
                    cuponsHtml += `
                        <div class="flex-shrink-0 w-16 h-16 bg-purple-500 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                            </svg>
                        </div>
                    `;
                }
                
                cuponsVisualContainer.innerHTML = cuponsHtml;
            };

            const updateCuponsSection = () => {
                const cuponsTitle = document.getElementById('cupons-section-title');
                const cuponsSubtitle = document.getElementById('cupons-section-subtitle');
                const cuponsRestamText = document.getElementById('cupons-restam-text');
                
                if (isSubscribed) {
                    const availableCupons = getAvailableCoupons().length;
                    cuponsTitle.textContent = "Cupons da assinatura";
                    cuponsSubtitle.textContent = `${availableCupons} para todas as compras`;
                    cuponsSubtitle.style.display = "block";
                    cuponsRestamText.innerHTML = `Restam <span class="font-semibold text-purple-600">${availableCupons} de ${availableCupons} cupons</span>`;
                    cuponsRestamText.style.display = "block";
                } else {
                    cuponsTitle.textContent = "Cupons";
                    cuponsSubtitle.style.display = "none";
                    cuponsRestamText.style.display = "none";
                }
                
                // Atualiza também a visualização dos cupons
                updateCuponsVisual();
            };


            const updateCashbackDisponivel = () => {
                const cashbackDisponivelElement = document.getElementById('cashback-disponivel');
                if (cashbackDisponivelElement) {
                    cashbackDisponivelElement.textContent = `R$ ${cashbackBalanceAmount.toFixed(2)}`;
                }
            };

            const updateEconomiaTotalValor = () => {
                const economiaTotalElement = document.getElementById('economia-total-valor');
                if (economiaTotalElement) {
                    economiaTotalElement.textContent = `R$ ${economiaTotal.toFixed(2)}`;
                }
            };

            const updateSubscriptionUI = () => {
                updateSubscriptionStatus();
                updateSubscriptionActionBtn();
                updateEconomiaTotalValor();
                updateCashbackBalance();
                updateCuponsSection();
                updateCashbackDisponivel();
                // Atualiza também a tela de simulação de compra
                updateCashbackInfo();
                updateServiceFeeSavings();
                updateTotalSavings();
                updatePurchaseActionSection();
            };

            // --- FUNÇÕES DE SIMULAÇÃO DE COMPRA ---
            const updateCashbackInfo = () => {
                const purchaseAmount = 1000;
                const cashbackRate = isSubscribed ? 0.01 : 0; // 1% para assinantes
                const cashbackAmount = purchaseAmount * cashbackRate;
                
                if (isSubscribed) {
                    cashbackInfo.innerHTML = `
                        <div class="flex items-center space-x-2 text-pink-600">
                            <span>Ganhe R$ ${cashbackAmount.toFixed(2)} de cashback</span>
                            <svg width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5h2v2H9V5Zm0 4h2v6H9V9Zm1-9C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0Zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8Z" fill="#FE35F1"/>
                            </svg>
                        </div>
                    `;
                } else {
                    cashbackInfo.innerHTML = `
                        <div class="flex items-center space-x-2 text-gray-500">
                            <span>Ganharia R$ 10,00 de cashback no Clube</span>
                            <svg width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5h2v2H9V5Zm0 4h2v6H9V9Zm1-9C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0Zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8Z" fill="#9CA3AF"/>
                            </svg>
                        </div>
                    `;
                }
            };
            
            const updateServiceFeeSavings = () => {
                const serviceFee = 20;
                const discountRate = 0.20; // 20% de desconto
                const savings = serviceFee * discountRate;
                
                if (isSubscribed) {
                    serviceFeeSavings.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-blue-800 font-medium">✓ Economia na taxa de serviço (20%)</span>
                            <span class="text-blue-800 font-semibold">-R$ ${savings.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    serviceFeeSavings.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-blue-600 font-medium">Economizaria na taxa (20%)</span>
                            <span class="text-blue-600 font-semibold">-R$ ${savings.toFixed(2)}</span>
                        </div>
                    `;
                }
            };
            
            const updateTotalSavings = () => {
                const purchaseAmount = 1000;
                const serviceFee = 20;
                const cashbackAmount = isSubscribed ? purchaseAmount * 0.01 : 0;
                const serviceFeeDiscount = isSubscribed ? serviceFee * 0.20 : 0;
                const couponDiscount = appliedCoupon ? appliedCoupon.value : 0;
                const totalSavingsAmount = cashbackAmount + serviceFeeDiscount + couponDiscount;
                
                if (isSubscribed && totalSavingsAmount > 0) {
                    totalSavings.innerHTML = `Economia total nesta compra: R$ ${totalSavingsAmount.toFixed(2)}`;
                } else if (!isSubscribed) {
                    const potentialSavings = (purchaseAmount * 0.01) + (serviceFee * 0.20);
                    totalSavings.innerHTML = `Economizaria R$ ${potentialSavings.toFixed(2)} no Clube de Benefícios`;
                } else {
                    totalSavings.innerHTML = '';
                }
            };

            // --- FUNÇÕES DE CUPOM NA COMPRA ---
            const showCouponSection = () => {
                const couponSection = document.getElementById('coupon-section');
                if (isSubscribed && getAvailableCoupons().length > 0) {
                    couponSection.style.display = 'block';
                } else {
                    couponSection.style.display = 'none';
                    appliedCoupon = null;
                    updatePurchaseTotal();
                    updateTotalSavings();
                }
            };

            const validateCoupon = (couponCode) => {
                if (!isSubscribed) {
                    return { valid: false, message: 'Você precisa ser membro do clube para usar cupons.' };
                }

                const coupon = getAvailableCoupons().find(c => c.code.toUpperCase() === couponCode.toUpperCase());
                if (!coupon) {
                    return { valid: false, message: 'Cupom não encontrado ou já foi utilizado.' };
                }

                const purchaseAmount = 1000;
                if (purchaseAmount < coupon.minValue) {
                    return { valid: false, message: `Este cupom é válido apenas para compras acima de R$ ${coupon.minValue.toFixed(2)}.` };
                }

                return { valid: true, coupon: coupon };
            };

            const applyCoupon = (couponCode) => {
                const couponInput = document.getElementById('coupon-input');
                const couponMessage = document.getElementById('coupon-message');
                const couponDiscount = document.getElementById('coupon-discount');
                const appliedCouponCode = document.getElementById('applied-coupon-code');
                const couponDiscountValue = document.getElementById('coupon-discount-value');
                
                const validation = validateCoupon(couponCode);
                
                if (!validation.valid) {
                    couponMessage.innerHTML = `<span class="text-red-600">${validation.message}</span>`;
                    couponDiscount.classList.add('hidden');
                    appliedCoupon = null;
                    updatePurchaseTotal();
                    updateTotalSavings();
                    return;
                }

                appliedCoupon = validation.coupon;
                couponInput.value = '';
                couponMessage.innerHTML = `<span class="text-green-600">✓ Cupom aplicado com sucesso!</span>`;
                
                appliedCouponCode.textContent = appliedCoupon.code;
                couponDiscountValue.textContent = `-R$ ${appliedCoupon.value.toFixed(2)}`;
                couponDiscount.classList.remove('hidden');
                
                updatePurchaseTotal();
                updateTotalSavings();
            };

            const updatePurchaseTotal = () => {
                const purchaseTotal = document.getElementById('purchase-total');
                if (!purchaseTotal) return;

                const purchaseAmount = 1000;
                const serviceFee = 20;
                const serviceFeeDiscount = isSubscribed ? serviceFee * 0.20 : 0;
                const couponDiscount = appliedCoupon ? appliedCoupon.value : 0;
                
                const total = purchaseAmount + serviceFee - serviceFeeDiscount - couponDiscount;
                purchaseTotal.textContent = `R$ ${total.toFixed(2)}`;
            };

            const updateCouponSectionVisibility = () => {
                const couponSection = document.getElementById('coupon-section');
                if (couponSection) {
                    if (isSubscribed && getAvailableCoupons().length > 0) {
                        couponSection.style.display = 'block';
                    } else {
                        couponSection.style.display = 'none';
                        appliedCoupon = null;
                        updatePurchaseTotal();
                        updateTotalSavings();
                    }
                }
            };

            // Event listener para aplicar cupom
            const setupCouponEventListeners = () => {
                const applyCouponBtn = document.getElementById('apply-coupon-btn');
                const couponInput = document.getElementById('coupon-input');
                
                if (applyCouponBtn) {
                    applyCouponBtn.addEventListener('click', () => {
                        const couponCode = couponInput.value.trim();
                        if (couponCode) {
                            applyCoupon(couponCode);
                        }
                    });
                }
                
                if (couponInput) {
                    couponInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const couponCode = couponInput.value.trim();
                            if (couponCode) {
                                applyCoupon(couponCode);
                            }
                        }
                    });
                }
            };

            window.finalizePurchase = () => {
                const purchaseAmount = 1000;
                const serviceFee = 20;
                const cashbackAmount = purchaseAmount * 0.01; // 1% de cashback
                const serviceFeeDiscount = serviceFee * 0.20; // 20% de desconto na taxa
                const couponDiscount = appliedCoupon ? appliedCoupon.value : 0;
                const totalSavingsAmount = cashbackAmount + serviceFeeDiscount + couponDiscount;
                
                if (addCashback(cashbackAmount, 'Cashback da compra simulada')) {
                    // Consome o cupom se foi aplicado
                    if (appliedCoupon) {
                        consumeCoupon(appliedCoupon.code);
                        appliedCoupon = null;
                        // Atualiza as visualizações dos cupons
                        updateCuponsVisual();
                        updateCuponsSection();
                    }
                    
                    // Adiciona a economia total
                    addEconomiaTotal(serviceFeeDiscount, cashbackAmount + couponDiscount, 'Economia da compra simulada');
                    
                    let alertMessage = `🎉 Compra finalizada com sucesso!\n\n✅ R$ ${cashbackAmount.toFixed(2)} de cashback adicionado ao seu saldo!`;
                    if (couponDiscount > 0) {
                        alertMessage += `\n🎟️ Cupom de R$ ${couponDiscount.toFixed(2)} aplicado!`;
                    }
                    alertMessage += `\n💰 Economia total nesta compra: R$ ${totalSavingsAmount.toFixed(2)}\n\nSeu novo saldo: R$ ${cashbackBalanceAmount.toFixed(2)}\nEconomia total acumulada: R$ ${economiaTotal.toFixed(2)}`;
                    
                    alert(alertMessage);
                    
                    // Limpa a seção de cupom
                    resetCouponSection();
                    
                    // Volta para o perfil
                    purchaseSimulationScreen.classList.add('hidden');
                    purchaseSimulationScreen.classList.remove('flex');
                    profileScreen.classList.remove('hidden');
                }
            };
            
            const updatePurchaseActionSection = () => {
                if (isSubscribed) {
                    purchaseActionSection.innerHTML = `
                        <button onclick="finalizePurchase()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl transition-all text-lg shadow-lg">
                            Finalizar Compra
                        </button>
                    `;
                } else {
                    purchaseActionSection.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-4">
                                <div class="flex items-center space-x-3 mb-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                    </svg>
                                    <div>
                                        <h3 class="font-semibold text-purple-800">Clube de Benefícios</h3>
                                        <p class="text-sm text-purple-600">Ganhe R$ 10,00 de cashback nesta compra!</p>
                                    </div>
                                </div>
                                <button id="join-club-from-purchase" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg transition-all">
                                    Aderir ao Clube e Ganhar Cashback
                                </button>
                            </div>
                            <button id="finalize-purchase-no-benefits-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-xl transition-all text-lg">
                                Finalizar Compra Sem Benefícios
                            </button>
                        </div>
                    `;
                    
                    // Adiciona event listener para o botão de aderir ao clube
                    const joinClubFromPurchaseBtn = document.getElementById('join-club-from-purchase');
                    if (joinClubFromPurchaseBtn) {
                        joinClubFromPurchaseBtn.addEventListener('click', () => {
                            // Vai para a tela de benefícios
                            purchaseSimulationScreen.classList.add('hidden');
                            purchaseSimulationScreen.classList.remove('flex');
                            benefitsScreen.classList.remove('hidden');
                            benefitsScreen.classList.add('flex');
                        });
                    }
                    
                    // Adiciona event listener para finalizar compra sem benefícios
                    const finalizePurchaseNoBenefitsBtn = document.getElementById('finalize-purchase-no-benefits-btn');
                    if (finalizePurchaseNoBenefitsBtn) {
                        finalizePurchaseNoBenefitsBtn.addEventListener('click', () => {
                            const purchaseAmount = 1000;
                            const serviceFee = 20;
                            // Usuários não assinados não ganham cashback nem desconto na taxa
                            const totalPaid = purchaseAmount + serviceFee;
                            const potentialSavings = (purchaseAmount * 0.01) + (serviceFee * 0.20);
                            
                            alert(`🛒 Compra finalizada!\n\n💰 Valor pago: R$ ${totalPaid.toFixed(2)}\n\n💡 Você poderia ter economizado R$ ${potentialSavings.toFixed(2)} no Clube de Benefícios!\n\n✨ Considere se juntar ao clube para economizar nas próximas compras.`);
                            
                            // Volta para o perfil
                            purchaseSimulationScreen.classList.add('hidden');
                            purchaseSimulationScreen.classList.remove('flex');
                            profileScreen.classList.remove('hidden');
                        });
                    }
                }
            };

            // --- FUNÇÕES ---
            const renderMedals = () => {
                const paidPlansCountStr = localStorage.getItem('pagaleve_paid_plans_count');
                let paidPlansCount = 0;
                
                // Só usar dados de planos pagos se existir no localStorage
                if (paidPlansCountStr) {
                    paidPlansCount = parseInt(paidPlansCountStr);
                    console.log(`🏅 Renderizando medalhas com base em ${paidPlansCount} planos pagos`);
                } else {
                    console.log('🏅 Renderizando medalhas sem dados de planos pagos (modo padrão)');
                }
                
                medalGrid.innerHTML = '';
                medals.forEach(medal => {
                    const medalEl = document.createElement('div');
                    medalEl.id = `medal-${medal.goal}`;
                    medalEl.className = 'flex flex-col items-center justify-center p-3 bg-white border border-gray-200 rounded-xl transition-all';
                    
                    const iconContainer = document.createElement('div');
                    iconContainer.id = `medal-icon-${medal.goal}`;
                    iconContainer.innerHTML = medal.unlocked ? unlockedIconSVG(medal.color, medal.ribbon) : lockedIconSVG;
                    
                    const textEl = document.createElement('span');
                    textEl.id = `medal-text-${medal.goal}`;
                    textEl.className = 'text-sm font-semibold text-gray-500 border border-gray-300 rounded-full px-3 py-1 transition-all';
                    
                    // Usar planos pagos apenas se existir dados, senão mostrar 0
                    let currentDisplay;
                    if (medal.unlocked) {
                        currentDisplay = medal.goal;
                    } else if (paidPlansCountStr) {
                        currentDisplay = Math.min(paidPlansCount, medal.goal);
                    } else {
                        currentDisplay = 0; // Padrão quando não há dados
                    }
                    
                    textEl.textContent = `${currentDisplay}/${medal.goal}`;

                    if (medal.unlocked) {
                        medalEl.classList.add('medal-unlocked');
                        textEl.classList.add('border-green-400', 'text-green-700');
                    }

                    medalEl.appendChild(iconContainer);
                    medalEl.appendChild(textEl);
                    medalGrid.appendChild(medalEl);
                });
            };

            // --- FUNÇÕES DE PERSISTÊNCIA DAS MEDALHAS ---
            const saveMedals = () => {
                saveToStorage(STORAGE_KEYS.MEDALS, medals);
            };
            
            const saveProgress = () => {
                saveToStorage(STORAGE_KEYS.PROGRESS, currentProgress);
            };

            const updateMedalsSummary = () => {
                const unlockedMedals = medals.filter(medal => medal.unlocked).length;
                const totalMedals = medals.length;
                
                medalsUnlockedCount.textContent = `${unlockedMedals} conquistada${unlockedMedals !== 1 ? 's' : ''}`;
                medalsTotalCount.textContent = totalMedals;
                
                // Atualizar progresso baseado nos planos pagos
                updateProgressBasedOnPaidPlans();
            };
            
            // Nova função para atualizar progresso baseado nos planos pagos
            const updateProgressBasedOnPaidPlans = () => {
                const paidPlansCountStr = localStorage.getItem('pagaleve_paid_plans_count');
                
                // Só atualizar se existir dados de planos pagos no localStorage
                if (!paidPlansCountStr) {
                    console.log('📊 Nenhum dado de planos pagos encontrado, mantendo progresso atual');
                    return;
                }
                
                const paidPlansCount = parseInt(paidPlansCountStr || '0');
                console.log(`📊 Atualizando progresso baseado em ${paidPlansCount} planos pagos salvos`);
                
                // Encontrar próxima medalha não desbloqueada
                const nextMedal = medals.find(medal => !medal.unlocked);
                
                if (nextMedal) {
                    // Calcular progresso para a próxima medalha
                    const prevMedal = medals[medals.indexOf(nextMedal) - 1];
                    const prevGoal = prevMedal ? prevMedal.goal : 0;
                    
                    const currentProgress = Math.min(paidPlansCount, nextMedal.goal);
                    const percentage = ((currentProgress - prevGoal) / (nextMedal.goal - prevGoal)) * 100;
                    
                    mainProgressBar.style.width = `${Math.max(0, Math.min(percentage, 100))}%`;
                    mainProgressText.textContent = `${currentProgress}/${nextMedal.goal}`;
                    
                    // Atualizar título
                    mainProgressTitle.textContent = `Até a próxima medalha (${nextMedal.goal} compras)`;
                    mainProgressContainer.classList.remove('bg-green-100', 'border-green-200');
                    mainProgressTitle.classList.remove('hidden');
                    completionMessage.classList.add('hidden');
                    completionMessage.classList.remove('flex');
                } else {
                    // Todas as medalhas conquistadas
                    mainProgressBar.style.width = '100%';
                    mainProgressContainer.classList.add('bg-green-100', 'border-green-200');
                    mainProgressTitle.classList.add('hidden');
                    completionMessage.classList.remove('hidden');
                    completionMessage.classList.add('flex');
                    mainProgressText.textContent = `${paidPlansCount}/${paidPlansCount}`;
                }
            };

            const updateUI = () => {
                // Atualiza medalhas individuais
                medals.forEach(medal => {
                    if (currentProgress >= medal.goal && !medal.unlocked) {
                        medal.unlocked = true;
                        const medalEl = document.getElementById(`medal-${medal.goal}`);
                        const iconEl = document.getElementById(`medal-icon-${medal.goal}`);
                        medalEl.classList.add('medal-unlocked');
                        iconEl.innerHTML = unlockedIconSVG(medal.color, medal.ribbon);
                    }
                    const textEl = document.getElementById(`medal-text-${medal.goal}`);
                    const currentDisplay = medal.unlocked ? medal.goal : Math.min(currentProgress, medal.goal);
                    textEl.textContent = `${currentDisplay}/${medal.goal}`;
                     if (medal.unlocked) {
                        textEl.classList.add('border-green-400', 'text-green-700');
                    }
                });

                // Atualiza barra de progresso principal
                const nextMedal = medals.find(m => !m.unlocked);
                if (nextMedal) {
                    const prevGoal = medals[medals.indexOf(nextMedal) - 1]?.goal || 0;
                    const percentage = ((currentProgress - prevGoal) / (nextMedal.goal - prevGoal)) * 100;
                    mainProgressBar.style.width = `${Math.min(percentage, 100)}%`;
                    mainProgressText.textContent = `${currentProgress}/${nextMedal.goal}`;
                } else {
                    // Todas as medalhas conquistadas
                    mainProgressBar.style.width = '100%';
                    mainProgressContainer.classList.add('bg-green-100', 'border-green-200');
                    mainProgressTitle.classList.add('hidden');
                    completionMessage.classList.remove('hidden');
                    completionMessage.classList.add('flex');
                    mainProgressText.textContent = `${MAX_PROGRESS}/${MAX_PROGRESS}`;
                    advanceBtn.disabled = true;
                }
                
                // Atualiza o resumo das medalhas
                updateMedalsSummary();
                
                // Salva estado das medalhas no localStorage
                saveMedals();
                saveProgress();
            };
            
            const resetSimulation = () => {
                currentProgress = 0;
                medals.forEach(m => m.unlocked = false);
                mainProgressBar.style.width = '0%';
                mainProgressText.textContent = '0/4';
                mainProgressContainer.classList.remove('bg-green-100', 'border-green-200');
                mainProgressTitle.classList.remove('hidden');
                completionMessage.classList.add('hidden');
                completionMessage.classList.remove('flex');
                advanceBtn.disabled = false;
                renderMedals();
                updateMedalsSummary();
                
                // Salva estado resetado no localStorage
                saveMedals();
                saveProgress();
            };

            // --- FUNÇÕES DOS CUPONS ---
            
            // Função para copiar código do cupom
            const copyCouponCode = (couponCode, buttonElement) => {
                try {
                    // Verificar se a API clipboard está disponível
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(couponCode).then(() => {
                            showCopySuccess(buttonElement, couponCode);
                        }).catch(err => {
                            console.error('Erro na API clipboard:', err);
                            fallbackCopyMethod(couponCode, buttonElement);
                        });
                    } else {
                        // Fallback para navegadores que não suportam clipboard API
                        fallbackCopyMethod(couponCode, buttonElement);
                    }
                } catch (error) {
                    console.error('Erro ao copiar cupom:', error);
                    alert('Erro ao copiar o código. Tente novamente.');
                }
            };

            // Método alternativo de cópia para navegadores antigos
            const fallbackCopyMethod = (couponCode, buttonElement) => {
                const textArea = document.createElement('textarea');
                textArea.value = couponCode;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showCopySuccess(buttonElement, couponCode);
                    } else {
                        alert(`Código do cupom: ${couponCode}\n\nCopie manualmente este código.`);
                    }
                } catch (err) {
                    document.body.removeChild(textArea);
                    console.error('Erro no fallback copy:', err);
                    alert(`Código do cupom: ${couponCode}\n\nCopie manualmente este código.`);
                }
            };

            // Função para mostrar feedback de sucesso
            const showCopySuccess = (buttonElement, couponCode) => {
                if (!buttonElement) return;
                
                const originalHTML = buttonElement.innerHTML;
                
                buttonElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Copiado!</span>
                `;
                buttonElement.classList.add('bg-green-500');
                buttonElement.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                
                // Voltar ao estado original após 2 segundos
                setTimeout(() => {
                    buttonElement.innerHTML = originalHTML;
                    buttonElement.classList.remove('bg-green-500');
                    buttonElement.classList.add('bg-purple-500', 'hover:bg-purple-600');
                }, 2000);
                
                console.log(`📋 Código do cupom copiado: ${couponCode}`);
            };

            // Tornar a função global para ser acessível pelos botões
            window.copyCouponCode = copyCouponCode;
            
            const renderCupons = () => {
                const cuponsContent = document.getElementById('cupons-content');
                
                if (isSubscribed) {
                    // Membro do clube - mostra todos os cupons desbloqueados
                    cuponsContent.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <h2 class="text-lg font-semibold text-green-700">Membro do Clube</h2>
                            </div>
                            <p class="text-sm text-green-600">Você tem acesso total aos cupons! Use os códigos abaixo:</p>
                        </div>
                        ${getAvailableCoupons().map(cupon => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-800">${cupon.title}</h3>
                                            <p class="text-sm text-gray-600">${cupon.description}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-medium">
                                            DISPONÍVEL
                                        </div>
                                    </div>
                                </div>
                                <div class="border-t border-gray-100 pt-3 mt-3">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="bg-gray-100 px-3 py-2 rounded-lg">
                                            <span class="text-sm font-mono font-semibold text-gray-800">${cupon.code}</span>
                                        </div>
                                        <div class="text-right text-sm">
                                            <span class="text-gray-500">Válido até:</span>
                                            <div class="font-semibold text-gray-800">${cupon.expiration}</div>
                                        </div>
                                    </div>
                                    <button 
                                        onclick="copyCouponCode('${cupon.code}', this)" 
                                        class="w-full bg-purple-500 hover:bg-purple-600 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors flex items-center justify-center space-x-2"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                        <span>Copiar Cupom</span>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    // Não é membro do clube - mostra cupons bloqueados
                    cuponsContent.innerHTML = `
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                                <h2 class="text-lg font-semibold text-orange-700">Cupons Exclusivos do Clube</h2>
                            </div>
                            <p class="text-sm text-orange-600">Torne-se membro do Clube de Benefícios para desbloquear os cupons!</p>
                        </div>
                        ${getAvailableCoupons().map(cupon => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm opacity-60 relative overflow-hidden">
                                <div class="absolute inset-0 bg-gray-100 bg-opacity-50"></div>
                                <div class="relative">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-12 h-12 bg-gray-300 rounded-lg flex items-center justify-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-gray-600">${cupon.title}</h3>
                                                <p class="text-sm text-gray-500">${cupon.description}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-medium">
                                                BLOQUEADO
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border-t border-gray-100 pt-3 mt-3">
                                        <div class="flex items-center justify-between">
                                            <div class="bg-gray-200 px-3 py-2 rounded-lg">
                                                <span class="text-sm font-mono font-semibold text-gray-500">••••••</span>
                                            </div>
                                            <div class="text-right text-sm">
                                                <span class="text-gray-400">Expira em:</span>
                                                <div class="font-semibold text-gray-500">${cupon.expiration}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        <div class="mt-6 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg p-4 text-white text-center">
                            <h3 class="font-semibold mb-2">Desbloqueie todos os cupons!</h3>
                            <p class="text-sm mb-3">Torne-se membro do Clube e ganhe acesso a cupons exclusivos</p>
                            <button id="join-club-from-cupons" class="bg-white text-purple-600 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors">
                                Aderir ao Clube
                            </button>
                        </div>
                    `;
                    
                    // Adiciona event listener para o botão de aderir ao clube
                    const joinClubFromCuponsBtn = document.getElementById('join-club-from-cupons');
                    if (joinClubFromCuponsBtn) {
                        joinClubFromCuponsBtn.addEventListener('click', () => {
                            cuponsScreen.classList.add('hidden');
                            cuponsScreen.classList.remove('flex');
                            benefitsScreen.classList.remove('hidden');
                            benefitsScreen.classList.add('flex');
                        });
                    }
                }
            };

            const advanceProgress = () => {
                if (currentProgress < MAX_PROGRESS) {
                    currentProgress++;
                    updateUI();
                }
            };

            // --- EVENT LISTENERS ---
            showAchievementsBtn.addEventListener('click', () => {
                profileScreen.classList.add('hidden');
                achievementsScreen.classList.remove('hidden');
                achievementsScreen.classList.add('flex');
                resetSimulation();
            });
            
            clubeBeneficiosBtn.addEventListener('click', () => {
                profileScreen.classList.add('hidden');
                if (isSubscribed) {
                    // Se já é assinante, mostra tela de assinatura ativa
                    activeSubscriptionScreen.classList.remove('hidden');
                    activeSubscriptionScreen.classList.add('flex');
                    updateSubscriptionDetails();
                } else {
                    // Se não é assinante, mostra tela de benefícios
                    benefitsScreen.classList.remove('hidden');
                    benefitsScreen.classList.add('flex');
                }
            });

            cuponsBtn.addEventListener('click', () => {
                profileScreen.classList.add('hidden');
                cuponsScreen.classList.remove('hidden');
                cuponsScreen.classList.add('flex');
                renderCupons();
            });

            // Event listener para "Ver detalhes" da seção de cupons na tela inicial
            const cuponsVerDetalhesBtn = document.getElementById('cupons-ver-detalhes-btn');
            cuponsVerDetalhesBtn.addEventListener('click', () => {
                profileScreen.classList.add('hidden');
                cuponsScreen.classList.remove('hidden');
                cuponsScreen.classList.add('flex');
                renderCupons();
            });


            // Event listener para "Ver todas" da seção de conquistas na tela inicial
            const conquistasVerDetalhesBtn = document.getElementById('conquistas-ver-detalhes-btn');
            conquistasVerDetalhesBtn.addEventListener('click', () => {
                profileScreen.classList.add('hidden');
                achievementsScreen.classList.remove('hidden');
                achievementsScreen.classList.add('flex');
                renderMedals();
            });
            
            backToProfileBtn.addEventListener('click', () => {
                achievementsScreen.classList.add('hidden');
                achievementsScreen.classList.remove('flex');
                profileScreen.classList.remove('hidden');
            });
            
            backToProfileFromBenefitsBtn.addEventListener('click', () => {
                benefitsScreen.classList.add('hidden');
                benefitsScreen.classList.remove('flex');
                profileScreen.classList.remove('hidden');
            });
            
            backToProfileFromActiveBtn.addEventListener('click', () => {
                activeSubscriptionScreen.classList.add('hidden');
                activeSubscriptionScreen.classList.remove('flex');
                profileScreen.classList.remove('hidden');
            });
            
            simularCompraBtn.addEventListener('click', () => {
                profileScreen.classList.add('hidden');
                purchaseSimulationScreen.classList.remove('hidden');
                purchaseSimulationScreen.classList.add('flex');
                updateCashbackInfo();
                updateServiceFeeSavings();
                updateTotalSavings();
                updatePurchaseActionSection();
                updateCouponSectionVisibility();
                setupCouponEventListeners();
                updatePurchaseTotal();
            });
            
            backToProfileFromPurchaseBtn.addEventListener('click', () => {
                purchaseSimulationScreen.classList.add('hidden');
                purchaseSimulationScreen.classList.remove('flex');
                profileScreen.classList.remove('hidden');
            });

            backToProfileFromCuponsBtn.addEventListener('click', () => {
                cuponsScreen.classList.add('hidden');
                cuponsScreen.classList.remove('flex');
                profileScreen.classList.remove('hidden');
            });
            
            // Removido o event listener do toggle
            
            subscribeBtn.addEventListener('click', () => {
                benefitsScreen.classList.add('hidden');
                benefitsScreen.classList.remove('flex');
                plansScreen.classList.remove('hidden');
                plansScreen.classList.add('flex');
            });
            
            backToBenefitsBtn.addEventListener('click', () => {
                plansScreen.classList.add('hidden');
                plansScreen.classList.remove('flex');
                benefitsScreen.classList.remove('hidden');
                benefitsScreen.classList.add('flex');
            });
            
            backToPlansBtn.addEventListener('click', () => {
                paymentScreen.classList.add('hidden');
                paymentScreen.classList.remove('flex');
                plansScreen.classList.remove('hidden');
                plansScreen.classList.add('flex');
            });
            
            // Seleção de planos
            planOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove seleção anterior
                    planOptions.forEach(opt => {
                        opt.classList.remove('border-purple-500', 'bg-purple-50');
                        opt.classList.add('border-gray-200');
                    });
                    
                    // Adiciona seleção atual
                    option.classList.remove('border-gray-200');
                    option.classList.add('border-purple-500', 'bg-purple-50');
                    
                    // Armazena plano selecionado
                    selectedPlan = {
                        months: parseInt(option.dataset.plan),
                        price: parseFloat(option.dataset.price),
                        total: parseFloat(option.dataset.total)
                    };
                    
                    // Habilita botão de continuar
                    continueToPaymentBtn.disabled = false;
                    continueToPaymentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    continueToPaymentBtn.classList.add('opacity-100', 'cursor-pointer');
                });
            });
            
            continueToPaymentBtn.addEventListener('click', () => {
                if (selectedPlan) {
                    // Atualiza resumo do plano
                    const planNames = {1: 'Mensal', 3: 'Trimestral', 6: 'Semestral'};
                    const economy = selectedPlan.total - selectedPlan.price;
                    
                    selectedPlanSummary.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Plano ${planNames[selectedPlan.months]}</span>
                            <span class="font-semibold">R$ ${selectedPlan.price.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${selectedPlan.months} mês${selectedPlan.months > 1 ? 'es' : ''} de benefícios</span>
                            <span class="text-sm text-gray-500">R$ ${(selectedPlan.price / selectedPlan.months).toFixed(2)}/mês</span>
                        </div>
                        ${economy > 0 ? `
                        <div class="flex justify-between items-center text-green-600">
                            <span class="text-sm">Economia</span>
                            <span class="font-semibold">R$ ${economy.toFixed(2)}</span>
                        </div>
                        ` : ''}
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between items-center font-bold text-lg">
                                <span>Total</span>
                                <span class="text-purple-600">R$ ${selectedPlan.price.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                    
                    paymentTotal.textContent = `R$ ${selectedPlan.price.toFixed(2)}`;
                    
                    // Navega para tela de pagamento
                    plansScreen.classList.add('hidden');
                    plansScreen.classList.remove('flex');
                    paymentScreen.classList.remove('hidden');
                    paymentScreen.classList.add('flex');
                }
            });
            
            simulatePaymentBtn.addEventListener('click', () => {
                if (selectedPlan) {
                    // Ativa a assinatura
                    activateSubscription(selectedPlan);
                    
                    // Vai para tela de assinatura ativa
                    paymentScreen.classList.add('hidden');
                    paymentScreen.classList.remove('flex');
                    activeSubscriptionScreen.classList.remove('hidden');
                    activeSubscriptionScreen.classList.add('flex');
                    
                    // Reset selections
                    selectedPlan = null;
                    planOptions.forEach(opt => {
                        opt.classList.remove('border-purple-500', 'bg-purple-50');
                        opt.classList.add('border-gray-200');
                    });
                    continueToPaymentBtn.disabled = true;
                    continueToPaymentBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    continueToPaymentBtn.classList.remove('opacity-100', 'cursor-pointer');
                }
            });
            
            cancelSubscriptionBtn.addEventListener('click', cancelSubscription);
            
            advanceBtn.addEventListener('click', advanceProgress);
            resetBtn.addEventListener('click', resetSimulation);


            // --- EVENT LISTENERS DO OTP ---
            // Formatação do telefone
            phoneInput.addEventListener('input', handlePhoneInput);
            
            // Tratamento especial para backspace em caracteres especiais
            phoneInput.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace') {
                    const input = e.target;
                    const cursorPos = input.selectionStart;
                    const currentValue = input.value;
                    
                    // Se o cursor está logo após um caractere especial, remove ele e o número anterior
                    if (cursorPos > 0) {
                        const charBeforeCursor = currentValue[cursorPos - 1];
                        if (['-', '(', ')', ' '].includes(charBeforeCursor)) {
                            e.preventDefault();
                            
                            // Remove o caractere especial e o número anterior
                            const numbers = currentValue.replace(/\D/g, '');
                            const newNumbers = numbers.slice(0, -1);
                            const formatted = formatPhoneNumber(newNumbers);
                            
                            input.value = formatted;
                            lastPhoneValue = formatted;
                            
                            // Posicionar cursor no final
                            setTimeout(() => {
                                input.setSelectionRange(formatted.length, formatted.length);
                            }, 0);
                            
                            sendOtpBtn.disabled = !isValidPhone(formatted);
                        }
                    }
                }
            });

            // Enviar OTP
            sendOtpBtn.addEventListener('click', () => {
                const phone = phoneInput.value;
                if (isValidPhone(phone)) {
                    initiatePhoneAuth(phone);
                }
            });

            // Voltar para tela de telefone
            backToPhoneBtn.addEventListener('click', () => {
                otpScreen.classList.add('hidden');
                phoneScreen.classList.remove('hidden');
                // Limpar campos OTP
                otpInputs.forEach(input => input.value = '');
                otpCode = '';
                verifyOtpBtn.disabled = true;
            });

            // Gerenciar inputs do OTP
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/\D/g, '');
                    e.target.value = value;
                    
                    if (value && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                    
                    // Verificar se todos os campos estão preenchidos
                    const code = Array.from(otpInputs).map(input => input.value).join('');
                    otpCode = code;
                    verifyOtpBtn.disabled = code.length !== 6;
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });

                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const paste = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
                    
                    otpInputs.forEach((input, i) => {
                        input.value = paste[i] || '';
                    });
                    
                    otpCode = paste;
                    verifyOtpBtn.disabled = paste.length !== 6;
                    
                    if (paste.length === 6) {
                        otpInputs[5].focus();
                    }
                });
            });

            // Verificar OTP
            verifyOtpBtn.addEventListener('click', () => {
                if (otpCode.length === 6) {
                    verifyOtp(otpCode);
                }
            });

            // Reenviar OTP
            resendOtpBtn.addEventListener('click', () => {
                if (currentPhone) {
                    initiatePhoneAuth(phoneInput.value);
                }
            });

            // Logout
            logoutBtn.addEventListener('click', () => {
                const confirmLogout = confirm('Tem certeza que deseja sair?');
                if (confirmLogout) {
                    logout();
                }
            });

            
            // --- INICIALIZAÇÃO ---
            
            // Inicializar variáveis críticas primeiro
            try {
                // Inicializar medalhas e progresso
                currentProgress = loadFromStorage(STORAGE_KEYS.PROGRESS, 0);
                
                // Verificar se precisamos migrar medalhas para os novos valores
                const savedMedals = loadFromStorage(STORAGE_KEYS.MEDALS, null);
                if (savedMedals && savedMedals.length > 0 && savedMedals[0].goal === 4) {
                    // Dados antigos detectados, usar valores padrão novos
                    console.log('🔄 Migrando medalhas para novos valores baseados em compras reais');
                    medals = [...defaultMedals];
                    saveToStorage(STORAGE_KEYS.MEDALS, medals);
                } else {
                    medals = loadFromStorage(STORAGE_KEYS.MEDALS, defaultMedals);
                }
                
                // Inicializar cashback
                cashbackData = loadFromStorage(STORAGE_KEYS.CASHBACK, { balance: 0, history: [] });
                cashbackBalanceAmount = cashbackData.balance || 0;
                
                // Inicializar economia total
                economiaData = loadFromStorage(STORAGE_KEYS.ECONOMIA_TOTAL, { 
                    totalAcumulado: 0, 
                    economiaTaxaServico: 0, 
                    economiaCashback: 0, 
                    history: [] 
                });
                economiaTotal = economiaData.totalAcumulado || 0;
                
            } catch (error) {
                console.warn('Erro ao carregar dados salvos, usando valores padrão:', error);
                cashbackData = { balance: 0, history: [] };
                cashbackBalanceAmount = 0;
                economiaData = { totalAcumulado: 0, economiaTaxaServico: 0, economiaCashback: 0, history: [] };
                economiaTotal = 0;
            }
            
            // Verificar se já está autenticado e se o token ainda é válido
            const isAuthenticated = localStorage.getItem('pagaleve_authenticated') === 'true' && isTokenValid();
            
            // Verificar se já temos dados do usuário salvos (nome) - mesmo sem token válido
            const savedCustomerData = localStorage.getItem('pagaleve_customer_data');
            let hasUserData = false;
            console.log('🔍 Debug - savedCustomerData:', savedCustomerData);
            
            try {
                if (savedCustomerData) {
                    const customerData = JSON.parse(savedCustomerData);
                    hasUserData = customerData && customerData.name;
                    console.log('🔍 Debug - customerData:', customerData);
                    console.log('🔍 Debug - hasUserData:', hasUserData);
                }
            } catch (error) {
                console.warn('Dados do usuário corrompidos, removendo:', error);
                localStorage.removeItem('pagaleve_customer_data');
            }
            
            console.log('🔍 Debug - isAuthenticated:', isAuthenticated);
            console.log('🔍 Debug - hasUserData final:', hasUserData);
            console.log('🔍 Debug - Condição final (isAuthenticated || hasUserData):', isAuthenticated || hasUserData);
            
            if (isAuthenticated || hasUserData) {
                console.log('✅ Redirecionando para menu principal!');
                phoneScreen.classList.add('hidden');
                otpScreen.classList.add('hidden');
                profileScreen.classList.remove('hidden');
                
                // Atualiza a interface
                updateEconomiaTotalValor();
                
                // Log do token existente e buscar dados do usuário
                const savedToken = localStorage.getItem('pagaleve_token');
                const savedPhone = localStorage.getItem('pagaleve_phone');
                
                if (isAuthenticated && savedToken) {
                    console.log('🔓 Usuário já autenticado com token válido');
                    console.log('📱 Telefone:', savedPhone);
                    console.log('🔑 Token:', savedToken);
                    
                    // Se não temos dados do cliente salvos, buscar
                    if (!hasUserData) {
                        getCustomerData(savedToken);
                    } else {
                        // Usar dados salvos e atualizar interface
                        const customerData = JSON.parse(savedCustomerData);
                        console.log('👤 Dados do usuário (cache):', customerData.name);
                        updateUserInterface(customerData);
                    }
                } else if (hasUserData) {
                    // Temos dados do usuário mas token expirou ou não existe
                    console.log('👤 Redirecionando para menu principal - usuário conhecido');
                    const customerData = JSON.parse(savedCustomerData);
                    console.log('👤 Nome do usuário encontrado:', customerData.name);
                    updateUserInterface(customerData);
                }
            } else {
                console.log('❌ Não redirecionando - indo para tela OTP');
                // Se havia autenticação mas token expirou, fazer logout
                if (localStorage.getItem('pagaleve_authenticated') === 'true') {
                    console.log('⏰ Token expirado, fazendo logout...');
                    logout();
                } else {
                    console.log('📱 Mostrando tela de telefone para novo login');
                    phoneScreen.classList.remove('hidden');
                    otpScreen.classList.add('hidden');
                    profileScreen.classList.add('hidden');
                }
            }
            

            
            // Inicializa a tela
            console.log('🚀 Inicializando aplicação Pagaleve com localStorage...');
            console.log('📊 Estado inicial carregado:', {
                isSubscribed,
                cashbackBalance: cashbackBalanceAmount,
                availableCoupons: getAvailableCoupons().length
            });
            
            renderMedals();
            updateMedalsSummary();
            updateCashbackBalance();
            updateSubscriptionUI();
            updateSubscriptionDetails();
            updateEconomiaTotalValor();
            updateCuponsVisual();
            
            // Inicializar conquistas com base em dados salvos de planos pagos (se disponível)
            const savedPaidPlansCount = localStorage.getItem('pagaleve_paid_plans_count');
            if (savedPaidPlansCount && !isNaN(parseInt(savedPaidPlansCount))) {
                console.log(`🏆 Inicializando conquistas com dados salvos: ${savedPaidPlansCount} planos pagos`);
                initializeAchievementsFromPaidPlans(parseInt(savedPaidPlansCount));
            } else {
                console.log('🏆 Nenhum dado de planos pagos encontrado, usando progresso padrão das medalhas');
            }
            
            // Função global para debug - pode ser chamada no console
            window.debugPagaleve = {
                clearAllData: () => {
                    Object.values(STORAGE_KEYS).forEach(key => {
                        localStorage.removeItem(key);
                    });
                    localStorage.removeItem('pagaleve_authenticated');
                    localStorage.removeItem('pagaleve_phone');
                    localStorage.removeItem('pagaleve_token');
                    localStorage.removeItem('pagaleve_refresh_token');
                    localStorage.removeItem('pagaleve_token_expiration');
                    localStorage.removeItem('pagaleve_customer_data');
                    localStorage.removeItem('pagaleve_economia_total');
                    location.reload();
                },
                showStorageData: () => {
                    console.log('📊 Dados do localStorage:');
                    console.log('🔐 Autenticado:', localStorage.getItem('pagaleve_authenticated'));
                    console.log('📱 Telefone:', localStorage.getItem('pagaleve_phone'));
                    console.log('🔑 Token:', localStorage.getItem('pagaleve_token'));
                    console.log('👤 Customer Data:', localStorage.getItem('pagaleve_customer_data'));
                    console.log('💰 Economia Total:', localStorage.getItem('pagaleve_economia_total'));
                    console.log('🏅 Medalhas:', localStorage.getItem('pagaleve_medals'));
                    console.log('📈 Progresso:', localStorage.getItem('pagaleve_progress'));
                },
                testUserRedirect: () => {
                    const fakeData = {
                        name: 'João Silva Teste',
                        email: 'joao@teste.com',
                        phone: '+5511999999999'
                    };
                    localStorage.setItem('pagaleve_customer_data', JSON.stringify(fakeData));
                    console.log('✅ Dados de teste salvos! Recarregue a página para testar redirecionamento.');
                    console.log('📋 Para testar, recarregue a página ou digite: location.reload()');
                }
            };
            
            console.log('✅ Aplicação inicializada com sucesso!');
            console.log('🔧 Para debug, use:');
            console.log('  - debugPagaleve.showStorageData() - Ver dados salvos');
            console.log('  - debugPagaleve.testUserRedirect() - Testar redirecionamento');
            console.log('  - debugPagaleve.clearAllData() - Limpar tudo');
        });
    </script>

</body>
</html>
